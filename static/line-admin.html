<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘·çˆ¸ - LINE ç¾¤çµ„ç®¡ç†</title>
  <link rel="icon" type="image/png" href="images/jaba-sm.png">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="js/menu-manager.js"></script>
</head>
<body>
  <!-- ç™»å…¥é©—è­‰ -->
  <div class="password-container" id="login-section">
    <a href="board.html" class="back-link back-link-standalone">â† è¿”å›çœ‹æ¿</a>
    <div class="password-box">
      <h2>ğŸ“± LINE ç¾¤çµ„ç®¡ç†</h2>
      <input type="text" id="group-code-input" placeholder="ç¾¤çµ„ä»£ç¢¼" autofocus onkeypress="handleLoginKeyPress(event)">
      <br>
      <button class="btn btn-primary" onclick="adminLogin()">ç™»å…¥</button>
      <p class="error-msg" id="login-error" style="display: none;"></p>
    </div>
  </div>

  <!-- ç®¡ç†ä»‹é¢ -->
  <div class="container admin-container" id="manage-section" style="display: none;">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="line-admin-header">
      <a href="board.html" class="back-link">â† è¿”å›çœ‹æ¿</a>
      <h1><img src="images/jaba-sm.png" alt="å‘·çˆ¸" class="logo-icon"> LINE ç¾¤çµ„ç®¡ç†</h1>
      <div class="header-actions">
        <button class="btn btn-sm btn-secondary" onclick="openChangeCodeModal()">ğŸ”‘ è®Šæ›´ä»£ç¢¼</button>
        <button class="btn btn-sm btn-secondary" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <!-- ä¸»è¦ç®¡ç†å€åŸŸ -->
    <div id="manage-panel">
      <div class="admin-three-columns line-admin-two-columns">
        <!-- å·¦å´ï¼šåº—å®¶ç®¡ç† -->
        <div class="admin-left-panel">
          <div class="panel-card stores-panel">
            <div class="panel-header">
              <span>ğŸ¬</span>
              <span>åº—å®¶ç®¡ç†</span>
              <button class="btn btn-sm btn-primary" onclick="showCreateStoreModal()" style="margin-left: auto;">+ æ–°å¢</button>
            </div>
            <button class="menu-upload-btn" onclick="menuManager.open()">
              ğŸ“· ä¸Šå‚³èœå–®
            </button>
            <div class="panel-content stores-panel-content" id="store-list">
              <div class="orders-empty">è¼‰å…¥ä¸­...</div>
            </div>
          </div>

        </div>

        <!-- å³å´ï¼šç¾¤çµ„/è¨‚å–®ç®¡ç† -->
        <div class="admin-right-panel">
          <!-- ç¾¤çµ„é¸æ“‡å™¨ -->
          <div class="panel-card group-selector-panel">
            <div class="panel-header">
              <span>ğŸ‘¥</span>
              <span>é¸æ“‡ç¾¤çµ„</span>
            </div>
            <div class="panel-content">
              <select id="group-selector" onchange="loadGroupData()">
                <option value="">-- é¸æ“‡ç¾¤çµ„ --</option>
              </select>
            </div>
          </div>

          <!-- ä»Šæ—¥åº—å®¶è¨­å®š -->
          <div class="panel-card store-info-panel" id="today-store-panel" style="display: none;">
            <div class="panel-header">
              <span>ğŸª</span>
              <span>ä»Šæ—¥åº—å®¶</span>
              <button class="btn btn-sm btn-primary" onclick="openTodayStoreModal()" style="margin-left:auto;">è¨­å®š</button>
            </div>
            <div class="panel-content" id="current-today-stores">
              <div class="orders-empty">å°šæœªè¨­å®š</div>
            </div>
          </div>

          <!-- ä»Šæ—¥è¨‚å–® -->
          <div class="panel-card orders-panel" id="orders-panel" style="display: none;">
            <div class="panel-header">
              <span>ğŸ“¦</span>
              <span>ä»Šæ—¥è¨‚å–®</span>
            </div>
            <!-- è¨‚å–®çµ±è¨ˆ -->
            <div class="panel-content orders-stats-section" id="orders-stats"></div>
            <!-- è¨‚å–®åˆ—è¡¨ -->
            <div class="panel-content" id="orders-content">
              <div class="orders-empty">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- èœå–®ç®¡ç†ï¼ˆå…¨å¯¬é¡¯ç¤ºï¼‰ -->
      <div class="panel-card" id="menu-manage-panel" style="display: none;">
        <div class="panel-header">
          <span>ğŸ“‹</span>
          <span>èœå–®ç®¡ç†</span>
          <button class="btn btn-sm btn-secondary" onclick="hideMenuPanel()" style="margin-left: auto;">è¿”å›</button>
        </div>
        <div class="panel-content">
          <div id="menu-store-info" class="menu-store-info"></div>

          <!-- èœå–®ä¸Šå‚³æŒ‰éˆ• -->
          <div class="menu-upload-section">
            <button class="menu-upload-btn" onclick="menuManager.open()">
              ğŸ“· ä¸Šå‚³èœå–®åœ–ç‰‡è¾¨è­˜
            </button>
          </div>

          <!-- ç¾æœ‰èœå–® -->
          <div id="current-menu-content">
            <h4>ğŸ“‹ ç¾æœ‰èœå–®</h4>
            <div id="menu-categories"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ–°å¢åº—å®¶ Modal -->
    <div class="modal-overlay" id="create-store-modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>æ–°å¢ç¾¤çµ„å°ˆå±¬åº—å®¶</h3>
          <button class="modal-close" onclick="hideCreateStoreModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>åº—å®¶åç¨± *</label>
            <input type="text" id="new-store-name" placeholder="ä¾‹ï¼šå¥½åƒä¾¿ç•¶">
          </div>
          <div class="form-group">
            <label>é›»è©±</label>
            <input type="text" id="new-store-phone" placeholder="ä¾‹ï¼š02-12345678">
          </div>
          <div class="form-group">
            <label>åœ°å€</label>
            <input type="text" id="new-store-address" placeholder="ä¾‹ï¼šå°åŒ—å¸‚ä¿¡ç¾©å€...">
          </div>
          <div class="form-group">
            <label>èªªæ˜</label>
            <textarea id="new-store-description" placeholder="åº—å®¶ç‰¹è‰²ã€ç‡Ÿæ¥­æ™‚é–“ç­‰"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="createStore()">å»ºç«‹</button>
          <button class="btn btn-secondary" onclick="hideCreateStoreModal()">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- è¨­å®šä»Šæ—¥åº—å®¶å°è©±æ¡† -->
    <div class="modal-overlay" id="today-store-modal" style="display: none;">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h3>ğŸª è¨­å®šä»Šæ—¥åº—å®¶</h3>
          <button class="modal-close" onclick="closeTodayStoreModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="today-store-checkboxes" class="store-checkbox-list" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
          <button class="btn btn-secondary" onclick="closeTodayStoreModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="saveTodayStores()">ç¢ºèªè¨­å®š</button>
        </div>
      </div>
    </div>

    <!-- è®Šæ›´ç¾¤çµ„ä»£ç¢¼å°è©±æ¡† -->
    <div class="modal-overlay" id="change-group-code-modal" style="display: none;">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h3>ğŸ”‘ è®Šæ›´ç¾¤çµ„ä»£ç¢¼</h3>
          <button class="modal-close" onclick="closeChangeGroupCodeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>ç›®å‰ä»£ç¢¼</label>
            <input type="text" id="current-group-code" placeholder="è«‹è¼¸å…¥ç›®å‰çš„ç¾¤çµ„ä»£ç¢¼">
          </div>
          <div class="form-group">
            <label>æ–°ä»£ç¢¼</label>
            <input type="text" id="new-group-code" placeholder="è«‹è¼¸å…¥æ–°çš„ç¾¤çµ„ä»£ç¢¼ï¼ˆ4-20å­—å…ƒï¼‰">
          </div>
          <div class="form-group">
            <label>ç¢ºèªæ–°ä»£ç¢¼</label>
            <input type="text" id="confirm-new-group-code" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°ä»£ç¢¼">
          </div>
          <div class="change-group-code-result" id="change-group-code-result" style="display: none;"></div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
          <button class="btn btn-secondary" onclick="closeChangeGroupCodeModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="changeGroupCode()">ç¢ºèªè®Šæ›´</button>
        </div>
      </div>
    </div>

    <!-- èœå–®åœ–ç‰‡ä¸Šå‚³å°è©±æ¡† -->
    <div class="modal-overlay" id="menu-upload-modal" style="display: none;">
      <div class="modal-content menu-upload-modal">
        <div class="modal-header">
          <h3>ğŸ“· ä¸Šå‚³èœå–®åœ–ç‰‡</h3>
          <button class="modal-close" onclick="menuManager.close()">&times;</button>
        </div>
        <div class="modal-body">
          <!-- åº—å®¶é¸æ“‡ï¼ˆåœ¨æ‰€æœ‰æ­¥é©Ÿéƒ½é¡¯ç¤ºï¼‰ -->
          <div class="store-select" style="margin-bottom: 15px;">
            <label>é¸æ“‡åº—å®¶ï¼š</label>
            <select id="target-store-select">
              <option value="">-- é¸æ“‡ç¾æœ‰åº—å®¶ --</option>
              <option value="__new__">+ æ–°å¢åº—å®¶</option>
            </select>
            <input type="text" id="new-store-name-input" placeholder="è¼¸å…¥æ–°åº—å®¶åç¨±" style="display: none;">
          </div>

          <!-- æ­¥é©Ÿ 1ï¼šä¸Šå‚³åœ–ç‰‡ -->
          <div id="upload-step" class="upload-step">
            <div class="upload-area" id="upload-area" onclick="document.getElementById('menu-image-input').click()">
              <div class="upload-icon">ğŸ“·</div>
              <div class="upload-text">é»æ“Šæˆ–æ‹–æ”¾åœ–ç‰‡åˆ°é€™è£¡</div>
              <div class="upload-hint">æ”¯æ´ JPGã€PNGï¼Œæœ€å¤§ 10MB</div>
            </div>
            <input type="file" id="menu-image-input" accept="image/jpeg,image/png" style="display: none;" onchange="menuManager.handleImageSelect(event)">

            <div class="upload-preview" id="upload-preview" style="display: none;">
              <img id="preview-image" src="" alt="é è¦½">
            </div>

            <div class="upload-error" id="upload-error" style="display: none;"></div>

            <div class="upload-actions">
              <button class="btn btn-secondary" id="clear-image-btn" onclick="menuManager.clearImage()" style="display: none;">æ¸…é™¤</button>
              <button class="btn btn-primary" id="recognize-btn" onclick="menuManager.recognize()" disabled>
                ğŸ” é–‹å§‹è¾¨è­˜
              </button>
            </div>
          </div>

          <!-- æ­¥é©Ÿ 2ï¼šè¾¨è­˜ä¸­ -->
          <div id="recognizing-step" class="upload-step" style="display: none;">
            <div class="loading-jaba">
              <img src="images/jaba-keyin-sm.png" alt="å‘·çˆ¸" class="loading-jaba-icon">
              <div class="loading-spinner-ring"></div>
            </div>
            <div class="loading-text">å‘·çˆ¸æ­£åœ¨åŠªåŠ› key èœå–®...</div>
          </div>

          <!-- æ­¥é©Ÿ 3ï¼šè¾¨è­˜çµæœ -->
          <div id="result-step" class="upload-step" style="display: none;">
            <div class="result-warnings" id="result-warnings"></div>
            <div class="result-editor" id="result-editor">
              <!-- å‹•æ…‹ç”Ÿæˆçš„ç·¨è¼¯è¡¨æ ¼ï¼ˆå«å·¦å³å…©æ¬„ï¼šèœå–®+åº—å®¶è³‡è¨Š+æŒ‰éˆ•ï¼‰ -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¢ºèªå°è©±æ¡† -->
  <div class="modal-overlay" id="confirm-modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 id="confirm-modal-title">ç¢ºèª</h3>
      </div>
      <div class="modal-body">
        <p id="confirm-modal-message" style="margin: 0; white-space: pre-wrap;"></p>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button class="btn" id="confirm-modal-cancel" style="background: #6c757d; color: white;">å–æ¶ˆ</button>
        <button class="btn btn-danger" id="confirm-modal-ok">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <script>
    // è‡ªå‹•åµæ¸¬ base pathï¼ˆæ”¯æ´ nginx åå‘ä»£ç†ï¼‰
    const basePath = (() => {
      const path = window.location.pathname;
      if (path.startsWith('/jaba-ai')) return '/jaba-ai';
      return '';
    })();
    console.log('basePath:', basePath, 'pathname:', window.location.pathname);

    function apiFetch(url, options = {}) {
      const fullUrl = basePath + url;
      console.log('API call:', fullUrl);
      return fetch(fullUrl, options);
    }

    // é€šçŸ¥å‡½æ•¸ï¼ˆå–ä»£ alertï¼‰- æ”¯æ´å †ç–Šé¡¯ç¤º
    function showNotification(message, type = 'success') {
      // å–å¾—æˆ–å»ºç«‹é€šçŸ¥å®¹å™¨
      let container = document.getElementById('notification-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.className = 'notification-container';
        document.body.appendChild(container);
      }

      const notif = document.createElement('div');
      notif.className = 'notification';
      if (type === 'error') {
        notif.style.background = '#f8d7da';
        notif.style.color = '#721c24';
        notif.style.borderLeft = '4px solid #dc3545';
      } else {
        notif.style.borderLeft = '4px solid #28a745';
      }
      notif.textContent = message;
      container.appendChild(notif);

      // æ·¡å‡ºä¸¦ç§»é™¤
      setTimeout(() => {
        notif.classList.add('fade-out');
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    function showConfirm(message, title = 'ç¢ºèª') {
      return new Promise((resolve) => {
        document.getElementById('confirm-modal-title').textContent = title;
        document.getElementById('confirm-modal-message').textContent = message;
        document.getElementById('confirm-modal').style.display = 'flex';

        const okBtn = document.getElementById('confirm-modal-ok');
        const cancelBtn = document.getElementById('confirm-modal-cancel');

        const cleanup = () => {
          document.getElementById('confirm-modal').style.display = 'none';
          okBtn.replaceWith(okBtn.cloneNode(true));
          cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        };

        document.getElementById('confirm-modal-ok').onclick = () => {
          cleanup();
          resolve(true);
        };
        document.getElementById('confirm-modal-cancel').onclick = () => {
          cleanup();
          resolve(false);
        };
      });
    }

    let currentUser = null;
    let currentGroupId = null;
    let currentGroupCode = null;  // ç™»å…¥æ™‚çš„ç¾¤çµ„ä»£ç¢¼
    let allStores = [];

    // === ç™»å…¥åŠŸèƒ½ ===
    function handleLoginKeyPress(event) {
      if (event.key === 'Enter') {
        adminLogin();
      }
    }

    async function adminLogin() {
      const groupCode = document.getElementById('group-code-input').value.trim();
      const errorEl = document.getElementById('login-error');

      if (!groupCode) {
        errorEl.textContent = 'è«‹è¼¸å…¥ç¾¤çµ„ä»£ç¢¼';
        errorEl.style.display = 'block';
        return;
      }

      try {
        const res = await apiFetch('/api/line-admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: groupCode }),
        });

        const data = await res.json();

        if (res.ok && data.success) {
          currentUser = data;
          currentGroupCode = groupCode;  // ä¿å­˜ç¾¤çµ„ä»£ç¢¼ä¾›å¾ŒçºŒ API ä½¿ç”¨
          errorEl.style.display = 'none';
          showManagePanel();
        } else {
          errorEl.textContent = data.detail || 'ä»£ç¢¼éŒ¯èª¤';
          errorEl.style.display = 'block';
        }
      } catch (err) {
        console.error('ç™»å…¥å¤±æ•—:', err);
        errorEl.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        errorEl.style.display = 'block';
      }
    }

    function logout() {
      currentUser = null;
      currentGroupId = null;
      currentGroupCode = null;
      document.getElementById('group-code-input').value = '';
      document.getElementById('manage-section').style.display = 'none';
      document.getElementById('login-section').style.display = 'flex';
    }

    async function showManagePanel() {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('manage-section').style.display = 'block';

      // å¡«å…¥ç¾¤çµ„é¸é …
      const selector = document.getElementById('group-selector');
      selector.innerHTML = '';
      currentUser.groups.forEach((group, index) => {
        const name = group.group_name || `ç¾¤çµ„ ${group.group_id.slice(-8)}`;
        const selected = index === 0 ? 'selected' : '';
        selector.innerHTML += `<option value="${group.group_id}" ${selected}>${name}</option>`;
      });

      // è¼‰å…¥åº—å®¶åˆ—è¡¨
      await loadStores();

      // åˆå§‹åŒ–èœå–®ç®¡ç†æ¨¡çµ„
      menuManager = new MenuManager({
        fetchFn: apiFetch,
        showNotification: showNotification,
        getStores: () => allStores,
        onMenuSaved: loadStores,
        apiPrefix: '/api/line-admin',
        groupCode: currentGroupCode,
        filterEditableStores: stores => stores.filter(s => s.can_edit),
        elements: {
          newStoreName: 'new-store-name-input',
        }
      });
      menuManager.init();

      // å¦‚æœæœ‰ç¾¤çµ„ï¼Œè‡ªå‹•è¼‰å…¥ç¬¬ä¸€å€‹ç¾¤çµ„çš„è³‡æ–™
      if (currentUser.groups.length > 0) {
        loadGroupData();
      }
    }

    async function loadStores() {
      try {
        // ä½¿ç”¨æ–°çš„ API å–å¾—ç¾¤çµ„å¯ç”¨åº—å®¶ï¼ˆå…¨å±€ + ç¾¤çµ„å°ˆå±¬ï¼‰
        const res = await apiFetch(`/api/line-admin/stores/by-code/${encodeURIComponent(currentGroupCode)}`);
        allStores = await res.json();
        renderStoreList();
      } catch (err) {
        console.error('è¼‰å…¥åº—å®¶å¤±æ•—:', err);
      }
    }

    function renderStoreList() {
      const el = document.getElementById('store-list');
      if (!allStores || allStores.length === 0) {
        el.innerHTML = '<div class="orders-empty">å°šç„¡åº—å®¶</div>';
        return;
      }

      // æ’åºï¼šå…ˆå…¨å±€å¾Œå°ˆå±¬ï¼Œå…ˆå•Ÿç”¨å¾Œåœç”¨
      allStores.sort((a, b) => {
        if (a.scope !== b.scope) return a.scope === 'global' ? -1 : 1;
        if (a.is_active !== b.is_active) return a.is_active ? -1 : 1;
        return a.name.localeCompare(b.name);
      });

      const html = allStores.map((store, index) => {
        const isActive = store.is_active !== false;

        const scopeTag = store.scope === 'global'
          ? '<span class="scope-tag global">å…¨å±€</span>'
          : '<span class="scope-tag group">å°ˆå±¬</span>';

        // å•Ÿç”¨/åœç”¨ icon
        const toggleIcon = store.can_edit
          ? (isActive
            ? `<span class="store-icon-btn active" onclick="event.stopPropagation(); toggleStoreActive('${store.id}')" title="é»æ“Šåœç”¨">âœ…</span>`
            : `<span class="store-icon-btn inactive" onclick="event.stopPropagation(); toggleStoreActive('${store.id}')" title="é»æ“Šå•Ÿç”¨">â¸ï¸</span>`)
          : (isActive
            ? `<span class="store-icon-btn active" title="å•Ÿç”¨ä¸­">âœ…</span>`
            : `<span class="store-icon-btn inactive" title="å·²åœç”¨">â¸ï¸</span>`);

        // åˆªé™¤ icon
        const deleteIcon = store.can_edit
          ? `<span class="store-icon-btn delete" onclick="event.stopPropagation(); confirmDeleteStore('${store.id}', '${store.name.replace(/'/g, "\\'")}')" title="åˆªé™¤åº—å®¶">ğŸ—‘ï¸</span>`
          : '';

        const menuBtn = store.can_edit
          ? `<span class="store-edit-btn" onclick="event.stopPropagation(); menuManager.editExisting('${store.id}')">èœå–®</span>`
          : '';

        return `
          <div class="store-manage-item">
            <div class="store-manage-header" onclick="toggleStoreMenu('${store.id}', ${index})">
              <div class="store-manage-info">
                ${scopeTag}
                ${toggleIcon}
                ${deleteIcon}
                <span class="store-manage-name">${store.name}</span>
                ${menuBtn}
              </div>
              <span class="store-manage-toggle" id="toggle-${index}">â–¼</span>
            </div>
            <div class="store-manage-detail" id="store-menu-${index}" style="display: none;" data-store-id="${store.id}" data-loaded="false">
              <div class="store-manage-meta">
                ${store.phone ? `<div>ğŸ“ ${store.phone}</div>` : ''}
                ${store.address ? `<div>ğŸ“ ${store.address}</div>` : ''}
              </div>
              <div class="store-menu-content" id="store-menu-content-${index}">
                <div class="loading-text">è¼‰å…¥ä¸­...</div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      el.innerHTML = html;
    }

    async function toggleStoreActive(storeId) {
      const store = allStores.find(s => s.id === storeId);
      if (!store || !store.can_edit) return;

      try {
        const res = await apiFetch(`/api/line-admin/stores/by-code/${encodeURIComponent(currentGroupCode)}/${storeId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: !store.is_active })
        });

        if (res.ok) {
          await loadStores();
        }
      } catch (err) {
        console.error('åˆ‡æ›åº—å®¶ç‹€æ…‹å¤±æ•—:', err);
      }
    }

    async function toggleStoreMenu(storeId, index) {
      const menuEl = document.getElementById(`store-menu-${index}`);
      const toggleEl = document.getElementById(`toggle-${index}`);
      const contentEl = document.getElementById(`store-menu-content-${index}`);

      if (menuEl.style.display === 'none') {
        menuEl.style.display = 'block';
        toggleEl.textContent = 'â–²';

        // è¼‰å…¥èœå–®ï¼ˆå¦‚æœé‚„æ²’è¼‰å…¥éï¼‰
        if (menuEl.dataset.loaded === 'false') {
          try {
            const res = await apiFetch(`/api/line-admin/stores/by-code/${encodeURIComponent(currentGroupCode)}/${storeId}/menu`);
            const menu = await res.json();

            if (menu && menu.categories && menu.categories.length > 0) {
              let html = '<div class="store-manage-menu">';
              menu.categories.forEach(cat => {
                html += `<div class="menu-cat-title">${cat.name}</div><div class="menu-cat-items">`;
                cat.items.forEach(item => {
                  const priceStr = item.variants && item.variants.length > 0
                    ? item.variants.map(v => `${v.name}$${v.price}`).join(' / ')
                    : `$${item.price}`;
                  html += `<div class="menu-cat-item"><span>${item.name}</span><span>${priceStr}</span></div>`;
                });
                html += '</div>';
              });
              html += '</div>';
              contentEl.innerHTML = html;
            } else {
              contentEl.innerHTML = '<div class="orders-empty">å°šç„¡èœå–®</div>';
            }
            menuEl.dataset.loaded = 'true';
          } catch (err) {
            console.error('è¼‰å…¥èœå–®å¤±æ•—:', err);
            contentEl.innerHTML = '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
          }
        }
      } else {
        menuEl.style.display = 'none';
        toggleEl.textContent = 'â–¼';
      }
    }

    async function loadGroupData() {
      const groupId = document.getElementById('group-selector').value;
      currentGroupId = groupId;

      if (!groupId) {
        document.getElementById('today-store-panel').style.display = 'none';
        document.getElementById('orders-panel').style.display = 'none';
        return;
      }

      document.getElementById('today-store-panel').style.display = 'block';
      document.getElementById('orders-panel').style.display = 'block';
      document.getElementById('menu-manage-panel').style.display = 'none';
      document.querySelector('.admin-three-columns').style.display = 'flex';

      await Promise.all([
        loadTodayStores(),
        loadOrders(),
      ]);
    }

    async function loadTodayStores() {
      const el = document.getElementById('current-today-stores');
      try {
        const res = await apiFetch(`/api/line-admin/groups/${currentGroupId}/today-stores`);
        const stores = await res.json();

        if (stores.length === 0) {
          el.innerHTML = '<div class="orders-empty">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
        } else {
          el.innerHTML = stores.map(s => `<div class="today-store-tag">${s.store_name}</div>`).join('');
        }
      } catch (err) {
        console.error('è¼‰å…¥ä»Šæ—¥åº—å®¶å¤±æ•—:', err);
        el.innerHTML = '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // === ä»Šæ—¥åº—å®¶ Modal ===
    async function openTodayStoreModal() {
      if (!currentGroupId) {
        showNotification('è«‹å…ˆé¸æ“‡ç¾¤çµ„', 'error');
        return;
      }

      // å–å¾—ç›®å‰ä»Šæ—¥åº—å®¶
      let currentTodayStoreIds = [];
      try {
        const res = await apiFetch(`/api/line-admin/groups/${currentGroupId}/today-stores`);
        const stores = await res.json();
        currentTodayStoreIds = stores.map(s => s.store_id);
      } catch (err) {
        console.error('å–å¾—ä»Šæ—¥åº—å®¶å¤±æ•—:', err);
      }

      // å¡«å……åº—å®¶é¸é …
      const container = document.getElementById('today-store-checkboxes');
      container.innerHTML = allStores.map(store => {
        const checked = currentTodayStoreIds.includes(store.id) ? 'checked' : '';
        return `
          <label class="store-checkbox">
            <input type="checkbox" value="${store.id}" ${checked}>
            <span>${store.name}</span>
          </label>
        `;
      }).join('');

      document.getElementById('today-store-modal').style.display = 'flex';
    }

    function closeTodayStoreModal() {
      document.getElementById('today-store-modal').style.display = 'none';
    }

    async function saveTodayStores() {
      const checkboxes = document.querySelectorAll('#today-store-checkboxes input:checked');
      const storeIds = Array.from(checkboxes).map(cb => cb.value);

      if (storeIds.length === 0) {
        showNotification('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åº—å®¶', 'error');
        return;
      }

      try {
        const res = await apiFetch(`/api/line-admin/groups/${currentGroupId}/today-stores`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ store_ids: storeIds }),
        });

        if (res.ok) {
          closeTodayStoreModal();
          await loadTodayStores();
        } else {
          showNotification('è¨­å®šå¤±æ•—', 'error');
        }
      } catch (err) {
        console.error('è¨­å®šå¤±æ•—:', err);
        showNotification('è¨­å®šå¤±æ•—', 'error');
      }
    }

    async function loadOrders() {
      const el = document.getElementById('orders-content');
      const statsEl = document.getElementById('orders-stats');
      try {
        const res = await apiFetch(`/api/line-admin/groups/${currentGroupId}/orders`);
        const sessions = await res.json();

        if (!sessions || sessions.length === 0) {
          el.innerHTML = '<div class="orders-empty">ä»Šæ—¥å°šç„¡è¨‚å–®</div>';
          if (statsEl) statsEl.innerHTML = '';
          return;
        }

        // çµ±è¨ˆè³‡æ–™
        let orderCount = 0;
        let totalAmount = 0;
        let paidAmount = 0;
        const itemCounts = {};

        let html = '';
        sessions.forEach(session => {
          session.orders.forEach(order => {
            orderCount++;
            totalAmount += order.total;
            if (order.payment_status === 'paid') {
              paidAmount += order.total;
            }

            const paidClass = order.payment_status === 'paid' ? 'paid' : '';
            const paidBadge = order.payment_status === 'paid'
              ? '<span class="payment-badge paid">å·²ä»˜</span>'
              : `<button class="btn btn-sm btn-success" onclick="markPaid('${order.id}')">ç¢ºèªæ”¶æ¬¾</button>`;

            const itemsHtml = order.items.map(item => {
              // çµ±è¨ˆå“é …
              itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity;

              // é¡¯ç¤ºå‚™è¨»
              let noteText = '';
              if (item.note) {
                noteText = `<span class="item-note">ï¼ˆ${item.note}ï¼‰</span>`;
              }
              return `<div class="order-item-line">${item.name}${noteText} x${item.quantity} $${item.subtotal}</div>`;
            }).join('');

            html += `
              <div class="group-order-item ${paidClass}">
                <div class="group-order-header">
                  <span class="group-order-user">ğŸ‘¤ ${order.display_name}</span>
                  <span class="group-order-total">$${order.total}</span>
                  ${paidBadge}
                </div>
                <div class="group-order-items">${itemsHtml}</div>
              </div>
            `;
          });
        });

        el.innerHTML = html || '<div class="orders-empty">ä»Šæ—¥å°šç„¡è¨‚å–®</div>';

        // æ¸²æŸ“çµ±è¨ˆå€å¡Š
        if (statsEl) {
          let statsHtml = `
            <div class="stats-overview">
              <div class="stat-item">
                <span class="stat-label">è¨‚å–®æ•¸</span>
                <span class="stat-value">${orderCount}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ç¸½é‡‘é¡</span>
                <span class="stat-value">$${totalAmount}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">å·²æ”¶</span>
                <span class="stat-value stats-collected">$${paidAmount}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">å¾…æ”¶</span>
                <span class="stat-value stats-pending">$${totalAmount - paidAmount}</span>
              </div>
            </div>
          `;

          const itemEntries = Object.entries(itemCounts);
          if (itemEntries.length > 0) {
            statsHtml += '<div class="stats-items-title">ğŸ“¦ å“é …çµ±è¨ˆ</div>';
            statsHtml += '<div class="stats-items">';
            itemEntries.sort((a, b) => b[1] - a[1]).forEach(([name, count]) => {
              statsHtml += `<div class="stats-item-row"><span>${name}</span><span>x${count}</span></div>`;
            });
            statsHtml += '</div>';
          }

          statsEl.innerHTML = statsHtml;
        }
      } catch (err) {
        console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', err);
        el.innerHTML = '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
        if (statsEl) statsEl.innerHTML = '';
      }
    }

    // ç¢ºèªæ”¶æ¬¾
    async function markPaid(orderId) {
      if (!await showConfirm('ç¢ºèªå·²æ”¶æ¬¾ï¼Ÿ')) return;

      try {
        const res = await fetch(`${basePath}/api/line-admin/orders/${orderId}/mark-paid`, {
          method: 'POST',
        });

        if (res.ok) {
          await loadOrders(); // é‡æ–°è¼‰å…¥è¨‚å–®
        } else {
          showNotification('æ“ä½œå¤±æ•—', 'error');
        }
      } catch (err) {
        console.error('æ”¶æ¬¾ç¢ºèªå¤±æ•—:', err);
        showNotification('æ“ä½œå¤±æ•—', 'error');
      }
    }

    // === Socket.IO å³æ™‚æ›´æ–° ===
    const socket = io({
      path: basePath + '/socket.io/'
    });

    socket.on('connect', () => {
      console.log('Socket connected');
      // åŠ å…¥å»£æ’­æˆ¿é–“
      socket.emit('join_board', { group_id: 'all' });
    });

    socket.on('order_update', (data) => {
      if (currentGroupId) {
        loadOrders();
      }
    });

    socket.on('session_status', (data) => {
      if (currentGroupId) {
        loadOrders();
      }
    });

    socket.on('payment_update', (data) => {
      if (currentGroupId) {
        loadOrders();
      }
    });

    socket.on('store_change', (data) => {
      const action = data.action || 'today_stores';
      if (action === 'store_created' || action === 'store_updated' || action === 'store_deleted') {
        // åº—å®¶åˆ—è¡¨è®Šæ›´ï¼Œé‡æ–°è¼‰å…¥
        if (currentGroupCode) {
          loadStores();
        }
        const actionText = action === 'store_created' ? 'æ–°å¢' : action === 'store_updated' ? 'æ›´æ–°' : 'åˆªé™¤';
        showNotification(`åº—å®¶ã€Œ${data.store_name}ã€å·²${actionText}`);
      } else if (currentGroupId) {
        // ä»Šæ—¥åº—å®¶è®Šæ›´
        loadTodayStores();
        showNotification('ä»Šæ—¥åº—å®¶å·²æ›´æ–°');
      }
    });

    // === è®Šæ›´ç¾¤çµ„ä»£ç¢¼åŠŸèƒ½ ===
    function openChangeCodeModal() {
      document.getElementById('current-group-code').value = '';
      document.getElementById('new-group-code').value = '';
      document.getElementById('confirm-new-group-code').value = '';
      document.getElementById('change-group-code-result').style.display = 'none';
      document.getElementById('change-group-code-modal').style.display = 'flex';
    }

    function closeChangeGroupCodeModal() {
      document.getElementById('change-group-code-modal').style.display = 'none';
    }

    async function changeGroupCode() {
      const currentCode = document.getElementById('current-group-code').value;
      const newCode = document.getElementById('new-group-code').value;
      const confirmCode = document.getElementById('confirm-new-group-code').value;
      const resultEl = document.getElementById('change-group-code-result');

      if (!currentCode || !newCode || !confirmCode) {
        resultEl.className = 'change-group-code-result error';
        resultEl.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
        resultEl.style.display = 'block';
        return;
      }

      if (newCode.length < 4 || newCode.length > 20) {
        resultEl.className = 'change-group-code-result error';
        resultEl.textContent = 'æ–°ä»£ç¢¼é•·åº¦éœ€ç‚º 4-20 å­—å…ƒ';
        resultEl.style.display = 'block';
        return;
      }

      if (newCode !== confirmCode) {
        resultEl.className = 'change-group-code-result error';
        resultEl.textContent = 'å…©æ¬¡è¼¸å…¥çš„æ–°ä»£ç¢¼ä¸ä¸€è‡´';
        resultEl.style.display = 'block';
        return;
      }

      try {
        const res = await apiFetch('/api/line-admin/change-group-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            current_code: currentCode,
            new_code: newCode,
          }),
        });

        const data = await res.json();

        if (res.ok && data.success) {
          resultEl.className = 'change-group-code-result success';
          resultEl.textContent = 'ç¾¤çµ„ä»£ç¢¼è®Šæ›´æˆåŠŸï¼ä¸‹æ¬¡è«‹ä½¿ç”¨æ–°ä»£ç¢¼ç™»å…¥ã€‚';
          resultEl.style.display = 'block';
          // æ¸…ç©ºè¼¸å…¥
          document.getElementById('current-group-code').value = '';
          document.getElementById('new-group-code').value = '';
          document.getElementById('confirm-new-group-code').value = '';
          // 3 ç§’å¾Œé—œé–‰ Modal
          setTimeout(() => {
            closeChangeGroupCodeModal();
          }, 3000);
        } else {
          resultEl.className = 'change-group-code-result error';
          resultEl.textContent = data.detail || 'ç¾¤çµ„ä»£ç¢¼è®Šæ›´å¤±æ•—';
          resultEl.style.display = 'block';
        }
      } catch (err) {
        console.error('ç¾¤çµ„ä»£ç¢¼è®Šæ›´å¤±æ•—:', err);
        resultEl.className = 'change-group-code-result error';
        resultEl.textContent = 'ç¾¤çµ„ä»£ç¢¼è®Šæ›´å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        resultEl.style.display = 'block';
      }
    }

    // === åº—å®¶ CRUD ===
    function showCreateStoreModal() {
      document.getElementById('create-store-modal').style.display = 'flex';
      document.getElementById('new-store-name').value = '';
      document.getElementById('new-store-phone').value = '';
      document.getElementById('new-store-address').value = '';
      document.getElementById('new-store-description').value = '';
    }

    function hideCreateStoreModal() {
      document.getElementById('create-store-modal').style.display = 'none';
    }

    async function createStore() {
      const name = document.getElementById('new-store-name').value.trim();
      if (!name) {
        showNotification('è«‹è¼¸å…¥åº—å®¶åç¨±', 'error');
        return;
      }

      try {
        const res = await apiFetch(`/api/line-admin/stores/by-code/${encodeURIComponent(currentGroupCode)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            phone: document.getElementById('new-store-phone').value.trim() || null,
            address: document.getElementById('new-store-address').value.trim() || null,
            description: document.getElementById('new-store-description').value.trim() || null,
          }),
        });

        if (res.ok) {
          showNotification('åº—å®¶å»ºç«‹æˆåŠŸï¼');
          hideCreateStoreModal();
          await loadStores();
        } else {
          const data = await res.json();
          showNotification(data.detail || 'å»ºç«‹å¤±æ•—', 'error');
        }
      } catch (err) {
        console.error('å»ºç«‹åº—å®¶å¤±æ•—:', err);
        showNotification('å»ºç«‹å¤±æ•—', 'error');
      }
    }

    async function confirmDeleteStore(storeId, storeName) {
      if (!await showConfirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${storeName}ã€å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

      try {
        const res = await apiFetch(`/api/line-admin/stores/by-code/${encodeURIComponent(currentGroupCode)}/${storeId}`, {
          method: 'DELETE',
        });

        if (res.ok) {
          showNotification('åº—å®¶å·²åˆªé™¤');
          await loadStores();
        } else {
          const data = await res.json();
          showNotification(data.detail || 'åˆªé™¤å¤±æ•—', 'error');
        }
      } catch (err) {
        console.error('åˆªé™¤åº—å®¶å¤±æ•—:', err);
        showNotification('åˆªé™¤å¤±æ•—', 'error');
      }
    }

    // === èœå–®ç®¡ç† ===
    let currentMenuStoreId = null;  // ç”¨æ–¼èœå–®é¢æ¿ï¼ˆç¨ç«‹æ–¼ä¸Šå‚³ Modalï¼‰

    async function showMenuPanel(storeId) {
      currentMenuStoreId = storeId;
      const store = allStores.find(s => s.id === storeId);

      document.getElementById('menu-store-info').innerHTML = `<h3>${store?.name || 'åº—å®¶'} - èœå–®ç®¡ç†</h3>`;
      document.querySelector('.admin-three-columns').style.display = 'none';
      document.getElementById('menu-manage-panel').style.display = 'block';
      document.querySelector('.menu-upload-section').style.display = 'block';

      await loadMenu();
    }

    function hideMenuPanel() {
      document.getElementById('menu-manage-panel').style.display = 'none';
      document.querySelector('.admin-three-columns').style.display = 'flex';
      currentMenuStoreId = null;
    }

    async function viewMenu(storeId) {
      currentMenuStoreId = storeId;
      const store = allStores.find(s => s.id === storeId);

      document.getElementById('menu-store-info').innerHTML = `<h3>${store?.name || 'åº—å®¶'} - èœå–®ï¼ˆå”¯è®€ï¼‰</h3>`;
      document.querySelector('.admin-three-columns').style.display = 'none';
      document.getElementById('menu-manage-panel').style.display = 'block';
      document.querySelector('.menu-upload-section').style.display = 'none';

      await loadMenu();
    }

    async function loadMenu() {
      const el = document.getElementById('menu-categories');
      try {
        const res = await apiFetch(`/api/line-admin/stores/by-code/${encodeURIComponent(currentGroupCode)}/${currentMenuStoreId}/menu`);
        const menu = await res.json();

        if (!menu.categories || menu.categories.length === 0) {
          el.innerHTML = '<div class="orders-empty">å°šç„¡èœå–®</div>';
          return;
        }

        const html = menu.categories.map(cat => `
          <div class="menu-category">
            <h5>${cat.name}</h5>
            <div class="menu-items">
              ${cat.items.map(item => `
                <div class="menu-item">
                  <span class="menu-item-name">${item.name}</span>
                  <span class="menu-item-price">$${item.price}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `).join('');

        el.innerHTML = html;
      } catch (err) {
        console.error('è¼‰å…¥èœå–®å¤±æ•—:', err);
        el.innerHTML = '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // === æ‹–æ”¾æ”¯æ´ ===
    document.addEventListener('DOMContentLoaded', function() {
      const uploadArea = document.getElementById('upload-area');
      if (uploadArea) {
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
          if (e.dataTransfer.files.length > 0 && menuManager) {
            menuManager.handleImageSelect({ target: { files: e.dataTransfer.files } });
          }
        });
      }
    });
  </script>
</body>
</html>
