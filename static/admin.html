<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘·çˆ¸ - ç®¡ç†å“¡</title>
  <link rel="icon" type="image/png" href="images/jaba-sm.png">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="js/menu-manager.js"></script>
  <style>
    /* å¯©æ ¸è©³æƒ…æ¨£å¼ */
    .review-detail {
      margin-bottom: 15px;
    }
    .review-row {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .review-row:last-child {
      border-bottom: none;
    }
    .review-label {
      font-weight: bold;
      color: #666;
      min-width: 100px;
      flex-shrink: 0;
    }
    .review-value {
      color: #333;
      word-break: break-word;
    }
    /* AI æ—¥èªŒè¡¨æ ¼æ¨£å¼ */
    .model-tag {
      background: #e3f2fd;
      color: #1565c0;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <!-- ç™»å…¥é©—è­‰ -->
  <div class="password-container" id="password-section">
    <a href="board.html" class="back-link back-link-standalone">â† è¿”å›çœ‹æ¿</a>
    <div class="password-box">
      <h2>ğŸ” ç®¡ç†å“¡ç™»å…¥</h2>
      <input type="text" id="username-input" placeholder="å¸³è™Ÿ" autofocus onkeypress="handlePasswordKeyPress(event)">
      <br>
      <input type="password" id="password-input" placeholder="å¯†ç¢¼" onkeypress="handlePasswordKeyPress(event)">
      <br>
      <button class="btn btn-primary" onclick="verifyPassword()">ç™»å…¥</button>
      <p class="error-msg" id="error-msg" style="display: none;"></p>
    </div>
  </div>

  <!-- ç®¡ç†ä»‹é¢ -->
  <div class="container admin-container" id="manager-section" style="display: none;">
    <!-- æ¨™ç±¤é å°èˆª -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('orders')">ğŸ“¦ è¨‚å–®ç®¡ç†</button>
      <button class="admin-tab" onclick="switchTab('stores')">ğŸ¬ åº—å®¶ç®¡ç†</button>
      <button class="admin-tab" onclick="switchTab('groups')">ğŸ‘¥ ç¾¤çµ„ç®¡ç†</button>
      <button class="admin-tab" onclick="switchTab('users')">ğŸ‘¤ ä½¿ç”¨è€…</button>
      <button class="admin-tab" onclick="switchTab('security')">ğŸ”’ é•è¦è¨˜éŒ„</button>
      <button class="admin-tab" onclick="switchTab('ai-logs')">ğŸ¤– AI æ—¥èªŒ</button>
      <button class="admin-tab" onclick="switchTab('settings')">âš™ï¸ ç³»çµ±è¨­å®š</button>
    </div>

    <!-- è¨‚å–®ç®¡ç†æ¨™ç±¤å…§å®¹ -->
    <div class="admin-tab-content active" id="tab-orders">
      <div class="admin-two-columns">
        <div class="admin-main-panel">
          <!-- ä»Šæ—¥åº—å®¶è³‡è¨Š -->
          <div class="panel-card store-info-panel">
            <div class="panel-header">
              <span>ğŸª</span>
              <span>ä»Šæ—¥åº—å®¶</span>
              <button class="btn btn-sm btn-primary" onclick="openTodayStoreModal()" style="margin-left:auto;">è¨­å®š</button>
            </div>
            <div class="panel-content" id="store-info-content">
              <div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>
            </div>
          </div>

          <!-- ç¾¤çµ„é¸æ“‡å™¨ -->
          <div class="panel-card group-selector-panel">
            <div class="panel-header">
              <span>ğŸ‘¥</span>
              <span>ç¾¤çµ„è¨‚å–®ç®¡ç†</span>
            </div>
            <div class="panel-content">
              <select id="group-selector" onchange="loadGroupOrders()">
                <option value="">-- é¸æ“‡ç¾¤çµ„ --</option>
              </select>
              <button class="btn btn-sm btn-secondary" onclick="refreshGroups()" title="é‡æ–°æ•´ç†">ğŸ”„</button>
            </div>
          </div>

          <!-- ç¾¤çµ„è¨‚å–®åˆ—è¡¨é¢æ¿ -->
          <div class="panel-card orders-panel">
            <div class="panel-header">
              <span>ğŸ“¦</span>
              <span>ç¾¤çµ„è¨‚å–®</span>
            </div>
            <div class="panel-content" id="orders-content" style="max-height: 400px;">
              <div class="orders-empty">è«‹é¸æ“‡ç¾¤çµ„</div>
            </div>
          </div>
        </div>

        <div class="admin-side-panel">
          <!-- è¨‚å–®çµ±è¨ˆé¢æ¿ -->
          <div class="panel-card stats-panel">
            <div class="panel-header">
              <span>ğŸ“Š</span>
              <span>è¨‚å–®çµ±è¨ˆ</span>
            </div>
            <div class="panel-content" id="stats-content">
              <div class="orders-empty">è«‹é¸æ“‡ç¾¤çµ„</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº—å®¶ç®¡ç†æ¨™ç±¤å…§å®¹ -->
    <div class="admin-tab-content" id="tab-stores">
      <div class="admin-two-columns">
        <div class="admin-main-panel">
          <div class="panel-card stores-panel">
            <div class="panel-header">
              <span>ğŸ¬</span>
              <span>åº—å®¶ç®¡ç†</span>
            </div>
            <button class="menu-upload-btn" onclick="menuManager.open()">
              ğŸ“· ä¸Šå‚³èœå–®
            </button>
            <div class="panel-content stores-panel-content" id="stores-content" style="max-height: none;">
              <div class="orders-empty">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        </div>
        <div class="admin-side-panel">
          <div class="panel-card">
            <div class="panel-header">
              <span>ğŸ’¡</span>
              <span>ä½¿ç”¨èªªæ˜</span>
            </div>
            <div class="panel-content" style="padding: 15px;">
              <p style="color: #666; line-height: 1.6;">
                â€¢ é»æ“Šã€Œä¸Šå‚³èœå–®ã€å¯æ–°å¢åº—å®¶<br>
                â€¢ é»æ“Šåº—å®¶å¡ç‰‡å¯ç·¨è¼¯è³‡è¨Š<br>
                â€¢ é»æ“Šèœå–®æŒ‰éˆ•å¯æŸ¥çœ‹/ç·¨è¼¯èœå–®<br>
                â€¢ å¯åˆ‡æ›å•Ÿç”¨/åœç”¨ç‹€æ…‹
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¾¤çµ„ç®¡ç†æ¨™ç±¤å…§å®¹ -->
    <div class="admin-tab-content" id="tab-groups">
      <div class="admin-two-columns">
        <div class="admin-main-panel">
          <!-- ç¾¤çµ„ç”³è«‹ Panel -->
          <div class="panel-card applications-panel">
            <div class="panel-header">
              <span>ğŸ“‹</span>
              <span>å¾…å¯©æ ¸ç”³è«‹</span>
              <span class="admin-tab-badge" id="pending-count" style="display: none;">0</span>
            </div>
            <div class="panel-content" id="applications-content">
              <div class="orders-empty">è¼‰å…¥ä¸­...</div>
            </div>
          </div>

          <!-- ç¾¤çµ„åˆ—è¡¨ -->
          <div class="panel-card">
            <div class="panel-header">
              <span>ğŸ‘¥</span>
              <span>ç¾¤çµ„åˆ—è¡¨</span>
            </div>
            <div class="panel-content" style="max-height: none; padding: 0;">
              <div class="admin-toolbar">
                <input type="text" class="search-input" id="group-search" placeholder="æœå°‹ç¾¤çµ„åç¨±æˆ–ä»£ç¢¼..." onkeyup="searchGroups()">
                <select id="group-status-filter" onchange="loadGroupsList()">
                  <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
                  <option value="active">å•Ÿç”¨ä¸­</option>
                  <option value="inactive">å·²é›¢é–‹</option>
                  <option value="pending">å¾…å¯©æ ¸</option>
                  <option value="suspended">å·²å‡çµ</option>
                  <option value="rejected">å·²æ‹’çµ•</option>
                </select>
              </div>
              <div class="admin-table-container">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>ç¾¤çµ„åç¨±</th>
                      <th>ä»£ç¢¼</th>
                      <th>æˆå“¡</th>
                      <th>ç‹€æ…‹</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="groups-table-body">
                    <tr><td colspan="5" class="orders-empty">è¼‰å…¥ä¸­...</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="pagination" id="groups-pagination"></div>
            </div>
          </div>
        </div>
        <div class="admin-side-panel">
          <div class="panel-card">
            <div class="panel-header">
              <span>ğŸ“Š</span>
              <span>ç¾¤çµ„çµ±è¨ˆ</span>
            </div>
            <div class="panel-content" id="groups-stats-content">
              <div class="orders-empty">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä½¿ç”¨è€…ç®¡ç†æ¨™ç±¤å…§å®¹ -->
    <div class="admin-tab-content" id="tab-users">
      <div class="admin-tab-inner">
        <div class="stats-cards" id="users-stats">
          <div class="stat-card">
            <div class="stat-value" id="total-users">-</div>
            <div class="stat-label">ç¸½ä½¿ç”¨è€…</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="active-users">-</div>
            <div class="stat-label">æ­£å¸¸ä½¿ç”¨è€…</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-value" id="banned-users">-</div>
            <div class="stat-label">å·²å°é–</div>
          </div>
        </div>

        <div class="admin-toolbar">
          <input type="text" class="search-input" id="user-search" placeholder="æœå°‹ä½¿ç”¨è€…åç¨±æˆ– LINE ID..." onkeyup="debounceUserSearch()">
          <select id="user-status-filter" onchange="loadUsersList()">
            <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="active">æ­£å¸¸</option>
            <option value="banned">å·²å°é–</option>
          </select>
        </div>

        <div class="panel-card" style="margin-top: 15px; flex: 1; display: flex; flex-direction: column; min-height: 0;">
          <div class="admin-table-container" style="flex: 1; overflow-y: auto;">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ä½¿ç”¨è€…</th>
                  <th>LINE ID</th>
                  <th>ç¾¤çµ„æ•¸</th>
                  <th>è¨‚å–®æ•¸</th>
                  <th>ç‹€æ…‹</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="users-table-body">
                <tr><td colspan="6" class="orders-empty">è¼‰å…¥ä¸­...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="pagination" id="users-pagination"></div>
        </div>
      </div>
    </div>

    <!-- é•è¦è¨˜éŒ„æ¨™ç±¤å…§å®¹ -->
    <div class="admin-tab-content" id="tab-security">
      <div class="admin-tab-inner">
        <div class="stats-cards" id="security-stats">
          <div class="stat-card warning">
            <div class="stat-value" id="today-violations">-</div>
            <div class="stat-label">ä»Šæ—¥é•è¦</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-value" id="week-violations">-</div>
            <div class="stat-label">æœ¬é€±é•è¦</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="total-violations">-</div>
            <div class="stat-label">ç¸½é•è¦æ•¸</div>
          </div>
        </div>

        <div class="panel-card" style="margin-top: 15px; flex: 1; display: flex; flex-direction: column; min-height: 0;">
          <div class="panel-header">
            <span>ğŸ”’</span>
            <span>é•è¦è¨˜éŒ„</span>
          </div>
          <div class="admin-table-container" style="flex: 1; overflow-y: auto;">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>æ™‚é–“</th>
                  <th>ä½¿ç”¨è€…</th>
                  <th>è¨Šæ¯å…§å®¹</th>
                  <th>è§¸ç™¼åŸå› </th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="security-table-body">
                <tr><td colspan="5" class="orders-empty">è¼‰å…¥ä¸­...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="pagination" id="security-pagination"></div>
        </div>
      </div>
    </div>

    <!-- AI æ—¥èªŒæ¨™ç±¤å…§å®¹ -->
    <div class="admin-tab-content" id="tab-ai-logs">
      <div class="admin-two-columns">
        <div class="admin-main-panel" style="flex: 1;">
          <div class="panel-card">
            <div class="panel-header">
              <span>ğŸ¤–</span>
              <span>AI å°è©±æ—¥èªŒ</span>
              <button class="btn btn-sm btn-secondary" onclick="loadAiLogs()" style="margin-left: auto;" title="é‡æ–°æ•´ç†">ğŸ”„</button>
            </div>
            <div class="panel-content" style="padding: 0;">
              <table class="data-table" id="ai-logs-table">
                <thead>
                  <tr>
                    <th style="width: 160px;">æ™‚é–“</th>
                    <th style="width: 100px;">ä½¿ç”¨è€…</th>
                    <th style="width: 120px;">ç¾¤çµ„</th>
                    <th style="width: 60px;">æ¨¡å‹</th>
                    <th>è¨Šæ¯æ‘˜è¦</th>
                    <th style="width: 80px;">è€—æ™‚</th>
                    <th style="width: 70px;">è¼¸å…¥</th>
                    <th style="width: 70px;">è¼¸å‡º</th>
                    <th style="width: 60px;">ç‹€æ…‹</th>
                  </tr>
                </thead>
                <tbody id="ai-logs-tbody">
                  <tr><td colspan="9" class="orders-empty">è¼‰å…¥ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="pagination" id="ai-logs-pagination"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Log è©³æƒ…å½ˆçª— -->
    <div class="modal-overlay" id="ai-log-detail-modal" style="display: none;">
      <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
        <div class="modal-header">
          <h3>ğŸ¤– AI å°è©±è©³æƒ…</h3>
          <button class="modal-close" onclick="closeAiLogDetailModal()">&times;</button>
        </div>
        <div class="modal-body" id="ai-log-detail-content" style="overflow-y: auto; max-height: calc(90vh - 120px);">
          <!-- å‹•æ…‹å¡«å…¥ -->
        </div>
      </div>
    </div>

    <!-- ç³»çµ±è¨­å®šæ¨™ç±¤å…§å®¹ -->
    <div class="admin-tab-content" id="tab-settings">
      <div class="admin-two-columns">
        <div class="admin-main-panel">
          <!-- AI æç¤ºè©ç®¡ç† -->
          <div class="panel-card prompts-panel">
            <div class="panel-header">
              <span>ğŸ¤–</span>
              <span>AI æç¤ºè©</span>
            </div>
            <div class="panel-content" id="prompts-panel-content">
              <div class="orders-empty">è¼‰å…¥ä¸­...</div>
            </div>
          </div>

          <!-- ç³»çµ±ç¶­è­· Panel -->
          <div class="panel-card maintenance-panel">
            <div class="panel-header">
              <span>ğŸ”§</span>
              <span>ç³»çµ±ç¶­è­·</span>
            </div>
            <div class="panel-content" id="maintenance-content">
              <div class="orders-empty">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        </div>

        <div class="admin-side-panel">
          <!-- LINE Bot ç‹€æ…‹ Panel -->
          <div class="panel-card linebot-panel">
            <div class="panel-header">
              <span>ğŸ¤–</span>
              <span>LINE Bot</span>
            </div>
            <div class="panel-content" style="padding: 10px 15px;">
              <div class="linebot-status" id="linebot-status">
                <span class="linebot-status-icon">ğŸ”„</span>
                <span class="linebot-status-text">æª¢æŸ¥ä¸­...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI æ‡¸æµ®å°è©±æ¡†æŒ‰éˆ• -->
  <button class="chat-widget-btn" id="chat-widget-btn" onclick="toggleChatWidget()">
    <img src="images/jaba-sm.png" alt="å‘·çˆ¸">
  </button>

  <!-- AI æ‡¸æµ®å°è©±æ¡† -->
  <div class="chat-widget" id="chat-widget">
    <div class="chat-widget-header">
      <img src="images/jaba-sm.png" alt="å‘·çˆ¸">
      <h4>å‘·çˆ¸åŠ©æ‰‹</h4>
      <button class="close-btn" onclick="toggleChatWidget()">&times;</button>
    </div>
    <div class="chat-widget-messages" id="chat-widget-messages">
      <div class="message assistant">
        <div class="message-content">ä½ å¥½ï¼æˆ‘æ˜¯å‘·çˆ¸åŠ©æ‰‹ã€‚æœ‰ä»€éº¼å¯ä»¥å¹«ä½ çš„å—ï¼Ÿ</div>
      </div>
    </div>
    <div class="chat-widget-input">
      <input type="text" id="chat-widget-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="handleChatWidgetKeyPress(event)">
      <button onclick="sendChatWidgetMessage()">â¤</button>
    </div>
  </div>

  <!-- è¨­å®šä»Šæ—¥åº—å®¶å°è©±æ¡† -->
  <div class="modal-overlay" id="today-store-modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3>ğŸª è¨­å®šä»Šæ—¥åº—å®¶</h3>
        <button class="modal-close" onclick="closeTodayStoreModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p id="today-store-group-name" style="margin-bottom: 15px; color: #666;"></p>
        <div id="today-store-checkboxes" class="store-checkbox-list" style="max-height: 300px; overflow-y: auto;"></div>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
        <button class="btn btn-secondary" onclick="closeTodayStoreModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveTodayStores()">ç¢ºèªè¨­å®š</button>
      </div>
    </div>
  </div>

  <!-- èœå–®åœ–ç‰‡ä¸Šå‚³å°è©±æ¡† -->
  <div class="modal-overlay" id="menu-upload-modal" style="display: none;">
    <div class="modal-content menu-upload-modal">
      <div class="modal-header">
        <h3>ğŸ“· ä¸Šå‚³èœå–®åœ–ç‰‡</h3>
        <button class="modal-close" onclick="menuManager.close()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- åº—å®¶é¸æ“‡ï¼ˆåœ¨æ‰€æœ‰æ­¥é©Ÿéƒ½é¡¯ç¤ºï¼‰ -->
        <div class="store-select" style="margin-bottom: 15px;">
          <label>é¸æ“‡åº—å®¶ï¼š</label>
          <select id="target-store-select">
            <option value="">-- é¸æ“‡ç¾æœ‰åº—å®¶ --</option>
            <option value="__new__">+ æ–°å¢åº—å®¶</option>
          </select>
          <input type="text" id="new-store-name-input" placeholder="è¼¸å…¥æ–°åº—å®¶åç¨±" style="display: none;">
        </div>

        <!-- æ­¥é©Ÿ 1ï¼šä¸Šå‚³åœ–ç‰‡ -->
        <div id="upload-step" class="upload-step">
          <div class="upload-area" id="upload-area" onclick="document.getElementById('menu-image-input').click()">
            <div class="upload-icon">ğŸ“·</div>
            <div class="upload-text">é»æ“Šæˆ–æ‹–æ”¾åœ–ç‰‡åˆ°é€™è£¡</div>
            <div class="upload-hint">æ”¯æ´ JPGã€PNGï¼Œæœ€å¤§ 10MB</div>
          </div>
          <input type="file" id="menu-image-input" accept="image/jpeg,image/png" style="display: none;" onchange="menuManager.handleImageSelect(event)">

          <div class="upload-preview" id="upload-preview" style="display: none;">
            <img id="preview-image" src="" alt="é è¦½">
          </div>

          <div class="upload-error" id="upload-error" style="display: none;"></div>

          <div class="upload-actions">
            <button class="btn btn-secondary" id="clear-image-btn" onclick="menuManager.clearImage()" style="display: none;">æ¸…é™¤</button>
            <button class="btn btn-primary" id="recognize-btn" onclick="menuManager.recognize()" disabled>
              ğŸ” é–‹å§‹è¾¨è­˜
            </button>
          </div>
        </div>

        <!-- æ­¥é©Ÿ 2ï¼šè¾¨è­˜ä¸­ -->
        <div id="recognizing-step" class="upload-step" style="display: none;">
          <div class="loading-jaba">
            <img src="images/jaba-keyin-sm.png" alt="å‘·çˆ¸" class="loading-jaba-icon">
            <div class="loading-spinner-ring"></div>
          </div>
          <div class="loading-text">å‘·çˆ¸æ­£åœ¨åŠªåŠ› key èœå–®...</div>
        </div>

        <!-- æ­¥é©Ÿ 3ï¼šç·¨è¼¯çµæœ -->
        <div id="result-step" class="upload-step" style="display: none;">
          <div class="result-warnings" id="result-warnings"></div>
          <div class="result-editor" id="result-editor">
            <!-- å‹•æ…‹ç”Ÿæˆçš„ç·¨è¼¯è¡¨æ ¼ï¼ˆå«å·¦å³å…©æ¬„ï¼šèœå–®+åº—å®¶è³‡è¨Š+æŒ‰éˆ•ï¼‰ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI æç¤ºè©ç·¨è¼¯å°è©±æ¡† -->
  <div class="modal-overlay" id="prompts-modal" style="display: none;">
    <div class="modal-content prompts-modal">
      <div class="modal-header">
        <h3>ğŸ¤– AI æç¤ºè©ç®¡ç†</h3>
        <button class="modal-close" onclick="closePromptsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="prompts-list">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>

  <!-- ç¾¤çµ„ç”³è«‹å¯©æ ¸å°è©±æ¡† -->
  <div class="modal-overlay" id="review-modal" style="display: none;">
    <div class="modal-content review-modal">
      <div class="modal-header">
        <h3>ğŸ“‹ å¯©æ ¸ç¾¤çµ„ç”³è«‹</h3>
        <button class="modal-close" onclick="closeReviewModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="review-content">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>
        <div class="review-actions">
          <button class="btn btn-danger" onclick="rejectApplication()">æ‹’çµ•</button>
          <button class="btn btn-primary" onclick="approveApplication()">é€šé</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é€šç”¨è©³æƒ…å°è©±æ¡† -->
  <div class="modal-overlay" id="detail-modal" style="display: none;" onclick="closeDetailModal(event)">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 id="detail-modal-title">è©³æƒ…</h3>
        <button class="modal-close" onclick="hideDetailModal()">&times;</button>
      </div>
      <div class="modal-body">
        <pre id="detail-modal-content" style="white-space: pre-wrap; word-wrap: break-word; margin: 0; font-family: inherit; background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;"></pre>
      </div>
    </div>
  </div>

  <!-- ç¢ºèªå°è©±æ¡† -->
  <div class="modal-overlay" id="confirm-modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 id="confirm-modal-title">ç¢ºèª</h3>
      </div>
      <div class="modal-body">
        <p id="confirm-modal-message" style="margin: 0; white-space: pre-wrap;"></p>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button class="btn" id="confirm-modal-cancel" style="background: #6c757d; color: white;">å–æ¶ˆ</button>
        <button class="btn btn-danger" id="confirm-modal-ok">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <script>
    // è‡ªå‹•åµæ¸¬ base pathï¼ˆæ”¯æ´ nginx åå‘ä»£ç†ï¼‰
    const basePath = window.location.pathname.includes('/jaba-ai/') ? '/jaba-ai' : '';
    const socket = io({
      path: basePath + '/socket.io/'
    });
    let adminUsername = 'ç®¡ç†å“¡';
    let adminToken = null;
    let allStores = [];
    let allGroups = [];
    let selectedGroupId = null;
    let currentGroupOrders = null;
    let reviewingAppId = null;
    let applicationsData = [];  // å­˜å„²ç”³è«‹è³‡æ–™ä¾›å¯©æ ¸å°è©±æ¡†ä½¿ç”¨

    // æ–°å¢è®Šæ•¸
    let usersPage = { offset: 0, limit: 20 };
    let groupsListPage = { offset: 0, limit: 20 };
    let securityPage = { offset: 0, limit: 50 };
    let userSearchTimeout = null;
    let groupSearchTimeout = null;

    // === æ¨™ç±¤é åˆ‡æ› ===
    function switchTab(tabName) {
      // æ›´æ–°æ¨™ç±¤æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.admin-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');

      // æ›´æ–°å…§å®¹é¡¯ç¤º
      document.querySelectorAll('.admin-tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // è¼‰å…¥å°æ‡‰æ¨™ç±¤çš„è³‡æ–™
      if (tabName === 'users') {
        loadUsersList();
      } else if (tabName === 'groups') {
        loadGroupsList();
      } else if (tabName === 'security') {
        loadSecurityLogs();
      } else if (tabName === 'ai-logs') {
        loadAiLogs();
      }
    }

    // === AI æ‡¸æµ®å°è©±æ¡† ===

    // ç°¡æ˜“ Markdown è§£æå™¨
    function parseMarkdown(text) {
      if (!text) return '';

      // å…ˆè™•ç†ç‰¹æ®Šå­—å…ƒè½‰ç¾© (é¿å… XSS)
      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // è™•ç†ç¨‹å¼ç¢¼å€å¡Š (```)
      html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

      // è™•ç†è¡Œå…§ç¨‹å¼ç¢¼ (`)
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

      // è™•ç†ç²—é«” (**text** æˆ– __text__)
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');

      // è™•ç†æ–œé«” (*text* æˆ– _text_)
      html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      html = html.replace(/_([^_]+)_/g, '<em>$1</em>');

      // è™•ç†æ¨™é¡Œ (### text)
      html = html.replace(/^### (.+)$/gm, '<h4>$1</h4>');
      html = html.replace(/^## (.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^# (.+)$/gm, '<h2>$1</h2>');

      // è™•ç†ç„¡åºåˆ—è¡¨ (- item æˆ– * item)
      html = html.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

      // è™•ç†æœ‰åºåˆ—è¡¨ (1. item)
      html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

      // è™•ç†æ›è¡Œ
      html = html.replace(/\n/g, '<br>');

      // æ¸…ç†å¤šé¤˜çš„ <br> åœ¨å€å¡Šå…ƒç´ å‰å¾Œ
      html = html.replace(/<br>(<\/?(ul|ol|li|pre|h[1-4])>)/g, '$1');
      html = html.replace(/(<\/?(ul|ol|li|pre|h[1-4])>)<br>/g, '$1');

      return html;
    }

    let chatWidgetHistory = [];

    function toggleChatWidget() {
      const widget = document.getElementById('chat-widget');
      widget.classList.toggle('open');
      if (widget.classList.contains('open')) {
        document.getElementById('chat-widget-input').focus();
      }
    }

    function handleChatWidgetKeyPress(event) {
      if (event.key === 'Enter') {
        sendChatWidgetMessage();
      }
    }

    async function sendChatWidgetMessage() {
      const input = document.getElementById('chat-widget-input');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';

      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      addChatWidgetMessage('user', message);
      chatWidgetHistory.push({ role: 'user', content: message });

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      const loadingId = addChatWidgetMessage('assistant', 'è™•ç†ä¸­...');

      try {
        const res = await authFetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            username: adminUsername,
            is_manager: true,
            group_id: selectedGroupId,
            history: chatWidgetHistory.slice(-10)
          })
        });

        const data = await res.json();
        document.getElementById(loadingId).remove();

        const reply = data.message || data.response || 'ï¼ˆç„¡å›æ‡‰ï¼‰';
        addChatWidgetMessage('assistant', reply);
        chatWidgetHistory.push({ role: 'assistant', content: reply });

        // åŸ·è¡Œ actions
        if (data.actions && data.actions.length > 0) {
          data.actions.forEach(action => {
            if (action.type === 'set_today_store') {
              updateTodayStoreInfo();
            }
          });
        }
      } catch (err) {
        document.getElementById(loadingId).remove();
        addChatWidgetMessage('assistant', 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    let chatWidgetMsgId = 0;
    function addChatWidgetMessage(role, content) {
      const messagesEl = document.getElementById('chat-widget-messages');
      const id = 'cwmsg-' + (chatWidgetMsgId++);

      const msgEl = document.createElement('div');
      msgEl.id = id;
      msgEl.className = `message ${role}`;

      // AI å›æ‡‰ä½¿ç”¨ Markdown è§£æï¼Œä½¿ç”¨è€…è¨Šæ¯ç›´æ¥é¡¯ç¤º
      const displayContent = role === 'assistant' ? parseMarkdown(content) : content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      msgEl.innerHTML = `<div class="message-content">${displayContent}</div>`;

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      return id;
    }

    // === ä½¿ç”¨è€…ç®¡ç† ===
    async function loadUsersList() {
      const search = document.getElementById('user-search')?.value || '';
      const status = document.getElementById('user-status-filter')?.value || 'all';

      try {
        const res = await authFetch(`/api/admin/users?limit=${usersPage.limit}&offset=${usersPage.offset}&search=${encodeURIComponent(search)}&status=${status}`);
        const data = await res.json();

        // æ›´æ–°çµ±è¨ˆ
        document.getElementById('total-users').textContent = data.total || 0;

        // è¨ˆç®—å„ç‹€æ…‹æ•¸é‡ï¼ˆå¾ API å›å‚³çš„è³‡æ–™ï¼‰
        const activeCount = data.users.filter(u => !u.is_banned).length;
        const bannedCount = data.users.filter(u => u.is_banned).length;
        document.getElementById('active-users').textContent = data.total - bannedCount;
        document.getElementById('banned-users').textContent = bannedCount;

        // æ¸²æŸ“è¡¨æ ¼
        const tbody = document.getElementById('users-table-body');
        if (data.users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="orders-empty">æ²’æœ‰ç¬¦åˆçš„ä½¿ç”¨è€…</td></tr>';
        } else {
          tbody.innerHTML = data.users.map(user => `
            <tr>
              <td>
                ${user.picture_url ? `<img src="${user.picture_url}" class="user-avatar">` : ''}
                ${user.display_name || 'æœªå‘½å'}
              </td>
              <td style="font-size: 0.85em; color: #666;">${maskLineId(user.line_user_id)}</td>
              <td>${user.group_count}</td>
              <td>${user.order_count}</td>
              <td>
                <span class="status-badge ${user.is_banned ? 'banned' : 'active'}">
                  ${user.is_banned ? 'å·²å°é–' : 'æ­£å¸¸'}
                </span>
              </td>
              <td class="action-btns">
                <button class="action-btn view" onclick="viewUserDetail('${user.id}')">è©³æƒ…</button>
                ${user.is_banned
                  ? `<button class="action-btn unban" onclick="unbanUser('${user.id}')">è§£å°</button>`
                  : `<button class="action-btn ban" onclick="banUser('${user.id}')">å°é–</button>`
                }
              </td>
            </tr>
          `).join('');
        }

        // æ¸²æŸ“åˆ†é 
        renderPagination('users-pagination', data.total, usersPage, loadUsersList);
      } catch (err) {
        console.error('è¼‰å…¥ä½¿ç”¨è€…å¤±æ•—:', err);
      }
    }

    function maskLineId(lineId) {
      if (!lineId || lineId.length < 10) return lineId;
      return lineId.substring(0, 6) + '...' + lineId.substring(lineId.length - 4);
    }

    function debounceUserSearch() {
      clearTimeout(userSearchTimeout);
      userSearchTimeout = setTimeout(() => {
        usersPage.offset = 0;
        loadUsersList();
      }, 300);
    }

    async function banUser(userId) {
      if (!await showConfirm('ç¢ºå®šè¦å°é–æ­¤ä½¿ç”¨è€…å—ï¼Ÿ')) return;

      try {
        const res = await authFetch(`/api/admin/users/${userId}/ban`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showNotification(data.message);
          loadUsersList();
        }
      } catch (err) {
        showNotification('æ“ä½œå¤±æ•—', 'error');
      }
    }

    async function unbanUser(userId) {
      if (!await showConfirm('ç¢ºå®šè¦è§£é™¤å°é–å—ï¼Ÿ')) return;

      try {
        const res = await authFetch(`/api/admin/users/${userId}/unban`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showNotification(data.message);
          loadUsersList();
        }
      } catch (err) {
        showNotification('æ“ä½œå¤±æ•—', 'error');
      }
    }

    async function viewUserDetail(userId) {
      try {
        const res = await authFetch(`/api/admin/users/${userId}`);
        const user = await res.json();

        const content = `åç¨±ï¼š${user.display_name}\nLINE IDï¼š${user.line_user_id}\nç¾¤çµ„æ•¸ï¼š${user.group_count}\nè¨‚å–®æ•¸ï¼š${user.order_count}\nç‹€æ…‹ï¼š${user.is_banned ? 'å·²å°é–' : 'æ­£å¸¸'}`;
        showDetailModal('ğŸ‘¤ ä½¿ç”¨è€…è©³æƒ…', content);
      } catch (err) {
        showNotification('è¼‰å…¥å¤±æ•—', 'error');
      }
    }

    // === ç¾¤çµ„ç®¡ç† ===
    function getGroupStatusText(status) {
      const statusMap = {
        'active': 'å•Ÿç”¨ä¸­',
        'inactive': 'å·²é›¢é–‹',
        'pending': 'å¾…å¯©æ ¸',
        'suspended': 'å·²å‡çµ',
        'rejected': 'å·²æ‹’çµ•'
      };
      return statusMap[status] || status;
    }

    function getGroupActionButtons(group) {
      let buttons = '';
      switch (group.status) {
        case 'active':
          buttons = `<button class="action-btn ban" onclick="suspendGroup('${group.id}')">å‡çµ</button>`;
          break;
        case 'inactive':
          buttons = `<button class="action-btn unban" onclick="activateGroup('${group.id}')">å•Ÿç”¨</button>`;
          break;
        case 'suspended':
          buttons = `<button class="action-btn unban" onclick="activateGroup('${group.id}')">è§£å‡</button>`;
          break;
        case 'pending':
          buttons = ''; // å¾…å¯©æ ¸åœ¨ç”³è«‹ç®¡ç†è™•ç†
          break;
        case 'rejected':
          buttons = `<button class="action-btn unban" onclick="activateGroup('${group.id}')">å•Ÿç”¨</button>`;
          break;
        default:
          buttons = '';
      }
      // æ‰€æœ‰ç‹€æ…‹éƒ½å¯ä»¥åˆªé™¤
      buttons += ` <button class="action-btn delete" onclick="deleteGroup('${group.id}', '${(group.name || '').replace(/'/g, "\\'")}')">åˆªé™¤</button>`;
      return buttons;
    }

    async function loadGroupsList() {
      const search = document.getElementById('group-search')?.value || '';
      const status = document.getElementById('group-status-filter')?.value || 'all';

      try {
        const res = await authFetch(`/api/admin/groups/list?limit=${groupsListPage.limit}&offset=${groupsListPage.offset}&search=${encodeURIComponent(search)}&status=${status}`);
        const data = await res.json();

        // æ›´æ–°çµ±è¨ˆ
        const statsEl = document.getElementById('groups-stats-content');
        const activeCount = data.groups.filter(g => g.status === 'active').length;
        statsEl.innerHTML = `
          <div style="text-align: center; padding: 10px;">
            <div style="font-size: 2em; color: #8B6914; font-weight: bold;">${data.total}</div>
            <div style="color: #666;">ç¸½ç¾¤çµ„æ•¸</div>
          </div>
        `;

        // æ¸²æŸ“è¡¨æ ¼
        const tbody = document.getElementById('groups-table-body');
        if (data.groups.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="orders-empty">æ²’æœ‰ç¬¦åˆçš„ç¾¤çµ„</td></tr>';
        } else {
          tbody.innerHTML = data.groups.map(group => `
            <tr>
              <td>
                <div><strong>${group.application_name || group.name || 'æœªå‘½å'}</strong></div>
                ${group.application_name && group.name && group.application_name !== group.name
                  ? `<div style="font-size: 12px; color: #666;">LINE: ${group.name}</div>`
                  : ''}
              </td>
              <td style="font-family: monospace;">${group.group_code || '-'}</td>
              <td>${group.member_count} / ${group.admin_count} ç®¡ç†</td>
              <td>
                <span class="status-badge ${group.status}">
                  ${getGroupStatusText(group.status)}
                </span>
              </td>
              <td class="action-btns">
                <button class="action-btn view" onclick="viewGroupDetail('${group.id}')">è©³æƒ…</button>
                ${getGroupActionButtons(group)}
              </td>
            </tr>
          `).join('');
        }

        // æ¸²æŸ“åˆ†é 
        renderPagination('groups-pagination', data.total, groupsListPage, loadGroupsList);
      } catch (err) {
        console.error('è¼‰å…¥ç¾¤çµ„å¤±æ•—:', err);
      }
    }

    function searchGroups() {
      clearTimeout(groupSearchTimeout);
      groupSearchTimeout = setTimeout(() => {
        groupsListPage.offset = 0;
        loadGroupsList();
      }, 300);
    }

    async function suspendGroup(groupId) {
      if (!await showConfirm('ç¢ºå®šè¦å‡çµæ­¤ç¾¤çµ„å—ï¼Ÿ')) return;

      try {
        const res = await authFetch(`/api/admin/groups/${groupId}/suspend`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showNotification(data.message);
          await loadGroupsList();
          await loadGroups();
        } else {
          showNotification(data.detail || 'æ“ä½œå¤±æ•—', 'error');
        }
      } catch (err) {
        showNotification('æ“ä½œå¤±æ•—', 'error');
      }
    }

    async function activateGroup(groupId) {
      if (!await showConfirm('ç¢ºå®šè¦å•Ÿç”¨æ­¤ç¾¤çµ„å—ï¼Ÿ')) return;

      try {
        const res = await authFetch(`/api/admin/groups/${groupId}/activate`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showNotification(data.message);
          await loadGroupsList();
          await loadGroups();
        } else {
          showNotification(data.detail || 'æ“ä½œå¤±æ•—', 'error');
        }
      } catch (err) {
        showNotification('æ“ä½œå¤±æ•—', 'error');
      }
    }

    async function deleteGroup(groupId, groupName) {
      if (!await showConfirm(`ç¢ºå®šè¦åˆªé™¤ç¾¤çµ„ã€Œ${groupName || groupId}ã€å—ï¼Ÿ\n\nåˆªé™¤å¾Œç¾¤çµ„å°‡ä¸æœƒé¡¯ç¤ºåœ¨åˆ—è¡¨ä¸­ï¼Œä½†è³‡æ–™æœƒä¿ç•™ï¼ˆå¯ç”±é–‹ç™¼äººå“¡æ¢å¾©ï¼‰ã€‚`)) return;

      try {
        const res = await authFetch(`/api/admin/groups/${groupId}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          showNotification(data.message);
          await loadGroupsList();
          await loadGroups();
        } else {
          showNotification(data.detail || 'åˆªé™¤å¤±æ•—', 'error');
        }
      } catch (err) {
        showNotification('åˆªé™¤å¤±æ•—', 'error');
      }
    }

    async function viewGroupDetail(groupId) {
      try {
        const res = await authFetch(`/api/admin/groups/${groupId}/detail`);
        const group = await res.json();

        const membersList = group.members.map(m => `${m.display_name || 'æœªå‘½å'}${m.is_admin ? ' (ç®¡ç†å“¡)' : ''}`).join('\n');
        const content = `åç¨±ï¼š${group.name}\nä»£ç¢¼ï¼š${group.group_code}\næˆå“¡æ•¸ï¼š${group.member_count}\n\næˆå“¡åˆ—è¡¨ï¼š\n${membersList || 'ç„¡æˆå“¡'}`;
        showDetailModal('ğŸ‘¥ ç¾¤çµ„è©³æƒ…', content);
      } catch (err) {
        showNotification('è¼‰å…¥å¤±æ•—', 'error');
      }
    }

    // === é•è¦è¨˜éŒ„ ===
    async function loadSecurityLogs() {
      try {
        // è¼‰å…¥çµ±è¨ˆ
        const statsRes = await authFetch('/api/admin/security-logs/stats');
        const stats = await statsRes.json();

        document.getElementById('today-violations').textContent = stats.today_count || 0;
        document.getElementById('week-violations').textContent = stats.week_count || 0;
        document.getElementById('total-violations').textContent = stats.total_count || 0;

        // è¼‰å…¥åˆ—è¡¨
        const res = await authFetch(`/api/admin/security-logs?limit=${securityPage.limit}&offset=${securityPage.offset}`);
        const data = await res.json();

        // å­˜å„²æ—¥èªŒå…§å®¹ä¾›æŸ¥çœ‹
        window.securityLogMessages = {};
        data.logs.forEach((log, idx) => {
          window.securityLogMessages[idx] = log.original_message;
        });

        const tbody = document.getElementById('security-table-body');
        if (data.logs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="orders-empty">æ²’æœ‰é•è¦è¨˜éŒ„</td></tr>';
        } else {
          tbody.innerHTML = data.logs.map((log, idx) => `
            <tr>
              <td style="font-size: 0.85em;">${formatDateTime(log.created_at)}</td>
              <td>${log.display_name || 'æœªçŸ¥'}</td>
              <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(log.original_message)}">
                ${escapeHtml(log.original_message.substring(0, 50))}${log.original_message.length > 50 ? '...' : ''}
              </td>
              <td>
                <div class="violation-reasons">
                  ${log.trigger_reasons.map(r => `<span class="violation-tag">${r}</span>`).join('')}
                </div>
              </td>
              <td>
                <button class="action-btn view" onclick="viewSecurityLog(${idx})">æŸ¥çœ‹</button>
              </td>
            </tr>
          `).join('');
        }

        renderPagination('security-pagination', data.total, securityPage, loadSecurityLogs);
      } catch (err) {
        console.error('è¼‰å…¥é•è¦è¨˜éŒ„å¤±æ•—:', err);
      }
    }

    function viewSecurityLog(idx) {
      const message = window.securityLogMessages?.[idx] || 'ç„¡æ³•è¼‰å…¥è¨Šæ¯';
      showDetailModal('ğŸ“ åŸå§‹è¨Šæ¯', message);
    }

    // === AI æ—¥èªŒ ===
    let aiLogsPage = { offset: 0, limit: 20 };

    async function loadAiLogs() {
      try {
        const res = await authFetch(`/api/admin/ai-logs?limit=${aiLogsPage.limit}&offset=${aiLogsPage.offset}`);
        const data = await res.json();

        const tbody = document.getElementById('ai-logs-tbody');
        if (data.logs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="orders-empty">æ²’æœ‰ AI æ—¥èªŒ</td></tr>';
        } else {
          tbody.innerHTML = data.logs.map(log => `
            <tr style="cursor: pointer;" onclick="viewAiLogDetail('${log.id}')">
              <td style="font-size: 0.85em;">${formatDateTime(log.created_at)}</td>
              <td>${escapeHtml(log.user_name || '-')}</td>
              <td>${escapeHtml(log.group_name || 'å€‹äºº')}</td>
              <td><span class="model-tag">${log.model}</span></td>
              <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${escapeHtml(log.parsed_message || '-')}
              </td>
              <td>${log.duration_ms ? log.duration_ms + ' ms' : '-'}</td>
              <td>${log.input_tokens || 0}</td>
              <td>${log.output_tokens || 0}</td>
              <td>
                <span class="status-badge ${log.success ? 'active' : 'inactive'}">
                  ${log.success ? 'âœ“' : 'âœ—'}
                </span>
              </td>
            </tr>
          `).join('');
        }

        renderPagination('ai-logs-pagination', data.total, aiLogsPage, loadAiLogs);
      } catch (err) {
        console.error('è¼‰å…¥ AI æ—¥èªŒå¤±æ•—:', err);
      }
    }

    async function viewAiLogDetail(logId) {
      try {
        const res = await authFetch(`/api/admin/ai-logs/${logId}`);
        const log = await res.json();

        const content = document.getElementById('ai-log-detail-content');
        content.innerHTML = `
          <div class="ai-log-detail">
            <div class="detail-section">
              <div class="detail-row">
                <span class="detail-label">æ™‚é–“</span>
                <span class="detail-value">${formatDateTime(log.created_at)}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">ä½¿ç”¨è€…</span>
                <span class="detail-value">${escapeHtml(log.user_name || '-')}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">ç¾¤çµ„</span>
                <span class="detail-value">${escapeHtml(log.group_name || 'å€‹äººå°è©±')}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">æ¨¡å‹</span>
                <span class="detail-value"><span class="model-tag">${log.model}</span></span>
              </div>
              <div class="detail-row">
                <span class="detail-label">è€—æ™‚</span>
                <span class="detail-value">${log.duration_ms ? log.duration_ms + ' ms' : '-'}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Tokenï¼ˆä¼°ç®—ï¼‰</span>
                <span class="detail-value">è¼¸å…¥: ${log.input_tokens || 0} / è¼¸å‡º: ${log.output_tokens || 0}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">ç‹€æ…‹</span>
                <span class="detail-value">
                  <span class="status-badge ${log.success ? 'active' : 'inactive'}">
                    ${log.success ? 'æˆåŠŸ' : 'å¤±æ•—'}
                  </span>
                </span>
              </div>
            </div>

            <div class="detail-section">
              <h4>ğŸ“¥ è¼¸å…¥ Prompt</h4>
              <pre class="prompt-content">${escapeHtml(log.input_prompt || '')}</pre>
            </div>

            <div class="detail-section">
              <h4>ğŸ“¤ AI åŸå§‹å›æ‡‰ï¼ˆå«æ€è€ƒéç¨‹ï¼‰</h4>
              <pre class="prompt-content">${escapeHtml(log.raw_response || '')}</pre>
            </div>

            <div class="detail-section">
              <h4>ğŸ’¬ è§£æå¾Œè¨Šæ¯</h4>
              <div class="parsed-message">${escapeHtml(log.parsed_message || '(ç©º)')}</div>
            </div>

            <div class="detail-section">
              <h4>âš¡ è§£æå¾Œå‹•ä½œ</h4>
              <pre class="actions-content">${log.parsed_actions ? JSON.stringify(log.parsed_actions, null, 2) : '[]'}</pre>
            </div>
          </div>

          <style>
            .ai-log-detail { }
            .detail-section { margin-bottom: 20px; }
            .detail-section h4 { margin: 0 0 10px 0; color: #666; font-size: 14px; }
            .detail-row { display: flex; padding: 6px 0; border-bottom: 1px solid #eee; }
            .detail-label { min-width: 80px; color: #888; }
            .detail-value { color: #333; }
            .model-tag { background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
            .prompt-content, .actions-content {
              background: #f5f5f5;
              padding: 12px;
              border-radius: 6px;
              font-size: 12px;
              line-height: 1.5;
              overflow-x: auto;
              max-height: 300px;
              white-space: pre-wrap;
              word-break: break-word;
            }
            .parsed-message {
              background: #fff8e1;
              padding: 12px;
              border-radius: 6px;
              line-height: 1.6;
            }
          </style>
        `;

        document.getElementById('ai-log-detail-modal').style.display = 'flex';
      } catch (err) {
        console.error('è¼‰å…¥ AI æ—¥èªŒè©³æƒ…å¤±æ•—:', err);
        showNotification('è¼‰å…¥å¤±æ•—', 'error');
      }
    }

    function closeAiLogDetailModal() {
      document.getElementById('ai-log-detail-modal').style.display = 'none';
    }

    // === é€šç”¨å‡½æ•¸ ===
    function formatDateTime(isoString) {
      if (!isoString) return '-';
      const d = new Date(isoString);
      return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function renderPagination(containerId, total, pageState, loadFunc) {
      const container = document.getElementById(containerId);
      const totalPages = Math.ceil(total / pageState.limit);
      const currentPage = Math.floor(pageState.offset / pageState.limit) + 1;

      container.innerHTML = `
        <button ${currentPage <= 1 ? 'disabled' : ''} onclick="changePage('${containerId}', -1)">ä¸Šä¸€é </button>
        <span class="page-info">ç¬¬ ${currentPage} / ${totalPages || 1} é ï¼ˆå…± ${total} ç­†ï¼‰</span>
        <button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage('${containerId}', 1)">ä¸‹ä¸€é </button>
      `;

      // å„²å­˜ loadFunc ä¾›åˆ†é æŒ‰éˆ•ä½¿ç”¨
      container.dataset.loadFunc = loadFunc.name;
    }

    function changePage(containerId, direction) {
      const container = document.getElementById(containerId);
      const funcName = container.dataset.loadFunc;

      if (containerId === 'users-pagination') {
        usersPage.offset += direction * usersPage.limit;
        if (usersPage.offset < 0) usersPage.offset = 0;
        loadUsersList();
      } else if (containerId === 'groups-pagination') {
        groupsListPage.offset += direction * groupsListPage.limit;
        if (groupsListPage.offset < 0) groupsListPage.offset = 0;
        loadGroupsList();
      } else if (containerId === 'security-pagination') {
        securityPage.offset += direction * securityPage.limit;
        if (securityPage.offset < 0) securityPage.offset = 0;
        loadSecurityLogs();
      } else if (containerId === 'ai-logs-pagination') {
        aiLogsPage.offset += direction * aiLogsPage.limit;
        if (aiLogsPage.offset < 0) aiLogsPage.offset = 0;
        loadAiLogs();
      }
    }

    // === å¸¶èªè­‰çš„ fetch ===
    function authFetch(url, options = {}) {
      if (!options.headers) {
        options.headers = {};
      }
      if (adminToken) {
        options.headers['Authorization'] = `Bearer ${adminToken}`;
      }
      return fetch(basePath + url, options);
    }

    // === ä¸€èˆ¬ fetchï¼ˆåŠ ä¸Š basePathï¼‰===
    function apiFetch(url, options = {}) {
      return fetch(basePath + url, options);
    }

    // === ç™»å…¥é©—è­‰ ===
    function handlePasswordKeyPress(event) {
      if (event.key === 'Enter') {
        verifyPassword();
      }
    }

    async function verifyPassword() {
      const username = document.getElementById('username-input').value;
      const password = document.getElementById('password-input').value;
      const errorMsg = document.getElementById('error-msg');

      if (!username || !password) {
        errorMsg.textContent = 'è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼';
        errorMsg.style.display = 'block';
        return;
      }

      try {
        const res = await apiFetch('/api/admin/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json();

        if (data.success) {
          adminToken = data.token;
          adminUsername = data.username || username;

          document.getElementById('password-section').style.display = 'none';
          document.getElementById('manager-section').style.display = 'flex';

          // åŠ å…¥è¶…ç®¡æˆ¿é–“ä»¥æ¥æ”¶ç”³è«‹å³æ™‚æ›´æ–°
          socket.emit('join_admin');

          // è¼‰å…¥è³‡æ–™
          loadAllStores();
          loadGroups();
          loadApplications();
          loadPromptsPanel();
          loadMaintenanceStats();
          startLineBotCheck();  // é–‹å§‹ LINE Bot ç‹€æ…‹æª¢æŸ¥

          // åˆå§‹åŒ–èœå–®ç®¡ç†æ¨¡çµ„
          menuManager = new MenuManager({
            fetchFn: authFetch,
            showNotification: showNotification,
            getStores: () => allStores,
            onMenuSaved: loadAllStores,
            apiPrefix: '/api/admin',
            groupCode: null,  // è¶…ç®¡ä¸éœ€è¦ group code
            filterEditableStores: stores => stores,  // è¶…ç®¡å¯ç·¨è¼¯æ‰€æœ‰åº—å®¶
            elements: {
              newStoreName: 'new-store-name-input',
            }
          });
          menuManager.init();

          // é¡¯ç¤ºæ­¡è¿é€šçŸ¥
          showNotification(`æ­¡è¿å›ä¾†ï¼Œ${adminUsername}ï¼`);
        } else {
          errorMsg.textContent = data.detail || 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
          errorMsg.style.display = 'block';
        }
      } catch (err) {
        errorMsg.textContent = 'é©—è­‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        errorMsg.style.display = 'block';
        console.error(err);
      }
    }

    // === åº—å®¶ç®¡ç† ===
    async function loadAllStores() {
      try {
        const res = await authFetch('/api/admin/stores');
        allStores = await res.json();
        updateStoresPanel(allStores);
        updateTodayStoreInfo();
      } catch (err) {
        console.error('è¼‰å…¥åº—å®¶å¤±æ•—:', err);
        document.getElementById('stores-content').innerHTML = '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    function updateStoresPanel(stores) {
      const content = document.getElementById('stores-content');
      if (!stores || stores.length === 0) {
        content.innerHTML = '<div class="orders-empty">å°šç„¡åº—å®¶è³‡æ–™</div>';
        return;
      }

      // æ’åºï¼šå…ˆå…¨å±€å¾Œå°ˆå±¬ï¼Œå…ˆå•Ÿç”¨å¾Œåœç”¨
      stores.sort((a, b) => {
        if (a.scope !== b.scope) return a.scope === 'global' ? -1 : 1;
        if (a.is_active !== b.is_active) return a.is_active ? -1 : 1;
        return a.name.localeCompare(b.name);
      });

      let html = '';
      stores.forEach((store, index) => {
        const isActive = store.is_active !== false;

        const scopeTag = store.scope === 'global'
          ? '<span class="scope-tag global">å…¨å±€</span>'
          : `<span class="scope-tag group">å°ˆå±¬</span>`;

        // å•Ÿç”¨/åœç”¨ icon
        const toggleIcon = isActive
          ? `<span class="store-icon-btn active" onclick="event.stopPropagation(); toggleStoreActive('${store.id}')" title="é»æ“Šåœç”¨">âœ…</span>`
          : `<span class="store-icon-btn inactive" onclick="event.stopPropagation(); toggleStoreActive('${store.id}')" title="é»æ“Šå•Ÿç”¨">â¸ï¸</span>`;

        // åˆªé™¤ icon
        const deleteIcon = `<span class="store-icon-btn delete" onclick="event.stopPropagation(); confirmDeleteStore('${store.id}', '${store.name.replace(/'/g, "\\'")}')" title="åˆªé™¤åº—å®¶">ğŸ—‘ï¸</span>`;

        html += `
          <div class="store-manage-item">
            <div class="store-manage-header" onclick="toggleStoreMenu('${store.id}', ${index})">
              <div class="store-manage-info">
                ${scopeTag}
                ${toggleIcon}
                ${deleteIcon}
                <span class="store-manage-name">${store.name}</span>
                <span class="store-edit-btn" onclick="event.stopPropagation(); menuManager.editExisting('${store.id}')">èœå–®</span>
              </div>
              <span class="store-manage-toggle" id="toggle-${index}">â–¼</span>
            </div>
            <div class="store-manage-detail" id="store-menu-${index}" style="display: none;" data-store-id="${store.id}" data-loaded="false">
              <div class="store-manage-meta">
                ${store.phone ? `<div>é›»è©±: ${store.phone}</div>` : ''}
                ${store.note ? `<div class="store-manage-note">ğŸ“Œ ${store.note}</div>` : ''}
              </div>
              <div class="store-menu-content" id="store-menu-content-${index}">
                <div class="loading-text">è¼‰å…¥ä¸­...</div>
              </div>
              <div class="store-menu-actions" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                <button class="btn btn-danger btn-sm" onclick="deleteMenu('${store.id}')">åˆªé™¤èœå–®</button>
              </div>
            </div>
          </div>
        `;
      });

      content.innerHTML = html;
    }

    async function toggleStoreActive(storeId) {
      const store = allStores.find(s => s.id === storeId);
      if (!store) return;

      try {
        const res = await authFetch(`/api/admin/stores/${storeId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: !store.is_active })
        });

        if (res.ok) {
          await loadAllStores();
        }
      } catch (err) {
        console.error('åˆ‡æ›åº—å®¶ç‹€æ…‹å¤±æ•—:', err);
      }
    }

    // === åˆªé™¤åº—å®¶ ===
    async function confirmDeleteStore(storeId, storeName) {
      if (!await showConfirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${storeName}ã€å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

      try {
        const res = await authFetch(`/api/admin/stores/${storeId}`, {
          method: 'DELETE',
        });

        if (res.ok) {
          showNotification('åº—å®¶å·²åˆªé™¤');
          await loadAllStores();
        } else {
          const data = await res.json();
          showNotification(data.detail || 'åˆªé™¤å¤±æ•—', 'error');
        }
      } catch (err) {
        console.error('åˆªé™¤åº—å®¶å¤±æ•—:', err);
        showNotification('åˆªé™¤å¤±æ•—', 'error');
      }
    }

    async function deleteMenu(storeId) {
      if (!await showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤åº—å®¶çš„èœå–®å—ï¼Ÿåº—å®¶è³‡æ–™æœƒä¿ç•™ã€‚')) return;

      try {
        const res = await authFetch(`/api/admin/stores/${storeId}/menu`, {
          method: 'DELETE',
        });

        if (res.ok) {
          showNotification('èœå–®å·²åˆªé™¤');
          await loadAllStores();
        } else {
          const data = await res.json();
          showNotification(data.detail || 'åˆªé™¤å¤±æ•—', 'error');
        }
      } catch (err) {
        console.error('åˆªé™¤èœå–®å¤±æ•—:', err);
        showNotification('åˆªé™¤å¤±æ•—', 'error');
      }
    }

    async function toggleStoreMenu(storeId, index) {
      const menuEl = document.getElementById(`store-menu-${index}`);
      const toggleEl = document.getElementById(`toggle-${index}`);
      const contentEl = document.getElementById(`store-menu-content-${index}`);

      if (menuEl.style.display === 'none') {
        menuEl.style.display = 'block';
        toggleEl.textContent = 'â–²';

        // è¼‰å…¥èœå–®ï¼ˆå¦‚æœé‚„æ²’è¼‰å…¥éï¼‰
        if (menuEl.dataset.loaded === 'false') {
          try {
            const res = await authFetch(`/api/admin/stores/${storeId}/menu/compare`);
            const menu = await res.json();

            if (menu && menu.categories && menu.categories.length > 0) {
              let html = '<div class="store-manage-menu">';
              menu.categories.forEach(cat => {
                html += `<div class="menu-cat-title">${cat.name}</div>
                  <div class="menu-cat-items">`;
                cat.items.forEach(item => {
                  const priceStr = item.variants && item.variants.length > 0
                    ? item.variants.map(v => `${v.name}$${v.price}`).join(' / ')
                    : `$${item.price}`;
                  const availClass = item.is_available === false ? ' unavailable' : '';
                  html += `<div class="menu-cat-item${availClass}">
                    <span>${item.name}</span>
                    <span>${priceStr}</span>
                  </div>`;
                });
                html += '</div>';
              });
              html += '</div>';
              contentEl.innerHTML = html;
            } else {
              contentEl.innerHTML = '<div class="no-menu-msg">å°šç„¡èœå–®</div>';
            }
            menuEl.dataset.loaded = 'true';
          } catch (err) {
            console.error('è¼‰å…¥èœå–®å¤±æ•—:', err);
            contentEl.innerHTML = '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
          }
        }
      } else {
        menuEl.style.display = 'none';
        toggleEl.textContent = 'â–¼';
      }
    }

    async function updateTodayStoreInfo() {
      const content = document.getElementById('store-info-content');
      const selectedGroupId = document.getElementById('group-selector').value;

      // å¾ board API å–å¾—ä»Šæ—¥åº—å®¶
      try {
        const res = await apiFetch('/api/board/today-stores');
        const data = await res.json();

        // å¦‚æœæœ‰é¸æ“‡ç¾¤çµ„ï¼Œåªé¡¯ç¤ºè©²ç¾¤çµ„çš„åº—å®¶
        if (selectedGroupId) {
          const groupData = data.find(g => g.group_id === selectedGroupId);
          if (groupData && groupData.stores.length > 0) {
            content.innerHTML = groupData.stores.map(s => `<div class="store-title">${s.store_name}</div>`).join('');
          } else {
            content.innerHTML = '<div class="no-store-msg">æ­¤ç¾¤çµ„å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
          }
        } else {
          // æ²’æœ‰é¸æ“‡ç¾¤çµ„æ™‚ï¼ŒæŒ‰ç¾¤çµ„åˆ†é–‹é¡¯ç¤º
          if (data.length === 0) {
            content.innerHTML = '<div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
            return;
          }

          let html = '';
          data.forEach(groupData => {
            const groupName = groupData.group_name || `ç¾¤çµ„ ${groupData.group_id.slice(-8)}`;
            const stores = groupData.stores.map(s => s.store_name).join('ã€') || 'æœªè¨­å®š';
            html += `<div class="store-title"><small>${groupName}ï¼š</small>${stores}</div>`;
          });
          content.innerHTML = html || '<div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
        }
      } catch (err) {
        content.innerHTML = '<div class="no-store-msg">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // === ä»Šæ—¥åº—å®¶è¨­å®š ===
    function openTodayStoreModal() {
      if (!selectedGroupId) {
        showNotification('è«‹å…ˆé¸æ“‡ç¾¤çµ„', 'error');
        return;
      }

      // æ‰¾åˆ°é¸ä¸­çš„ç¾¤çµ„åç¨±
      const group = allGroups.find(g => g.id === selectedGroupId);
      const groupName = group ? (group.name || `ç¾¤çµ„ ...${group.line_group_id.slice(-8)}`) : 'æœªçŸ¥ç¾¤çµ„';
      document.getElementById('today-store-group-name').textContent = `è¨­å®šã€Œ${groupName}ã€çš„ä»Šæ—¥åº—å®¶ï¼š`;

      // æ¸²æŸ“åº—å®¶ checkbox åˆ—è¡¨
      renderTodayStoreCheckboxes();

      // é¡¯ç¤º modal
      document.getElementById('today-store-modal').style.display = 'flex';
    }

    function closeTodayStoreModal() {
      document.getElementById('today-store-modal').style.display = 'none';
    }

    async function renderTodayStoreCheckboxes() {
      const container = document.getElementById('today-store-checkboxes');

      // å–å¾—è©²ç¾¤çµ„ç›®å‰çš„ä»Šæ—¥åº—å®¶
      let currentStoreIds = [];
      try {
        const res = await authFetch(`/api/admin/groups/${selectedGroupId}/today-stores`);
        const todayStores = await res.json();
        currentStoreIds = todayStores.map(s => s.store_id);
      } catch (err) {
        console.error('å–å¾—ä»Šæ—¥åº—å®¶å¤±æ•—:', err);
      }

      // æ¸²æŸ“æ‰€æœ‰åº—å®¶çš„ checkbox
      container.innerHTML = allStores
        .filter(store => store.is_active)
        .map(store => {
          const checked = currentStoreIds.includes(store.id) ? 'checked' : '';
          return `
            <label style="display: block; margin-bottom: 8px; cursor: pointer;">
              <input type="checkbox" value="${store.id}" ${checked} style="margin-right: 8px;">
              ${store.name}
            </label>
          `;
        }).join('');
    }

    async function saveTodayStores() {
      const checkboxes = document.querySelectorAll('#today-store-checkboxes input:checked');
      const storeIds = Array.from(checkboxes).map(cb => cb.value);

      if (storeIds.length === 0) {
        showNotification('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åº—å®¶', 'error');
        return;
      }

      try {
        const res = await authFetch(`/api/admin/groups/${selectedGroupId}/today-stores`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ store_ids: storeIds }),
        });

        if (res.ok) {
          showNotification('ä»Šæ—¥åº—å®¶è¨­å®šæˆåŠŸï¼');
          closeTodayStoreModal();
          updateTodayStoreInfo();
        } else {
          showNotification('è¨­å®šå¤±æ•—', 'error');
        }
      } catch (err) {
        console.error('è¨­å®šä»Šæ—¥åº—å®¶å¤±æ•—:', err);
        showNotification('è¨­å®šå¤±æ•—', 'error');
      }
    }

    // === ç¾¤çµ„ç®¡ç† ===
    async function loadGroups() {
      try {
        const res = await authFetch('/api/admin/groups');
        allGroups = await res.json();
        updateGroupSelector();
      } catch (err) {
        console.error('è¼‰å…¥ç¾¤çµ„å¤±æ•—:', err);
      }
    }

    function refreshGroups() {
      loadGroups();
      if (selectedGroupId) {
        loadGroupOrders();
      }
      showNotification('å·²é‡æ–°æ•´ç†');
    }

    function updateGroupSelector() {
      const select = document.getElementById('group-selector');
      let html = '<option value="">-- é¸æ“‡ç¾¤çµ„ --</option>';

      allGroups.forEach(group => {
        const selected = group.id === selectedGroupId ? 'selected' : '';
        const displayName = group.name || `ç¾¤çµ„ ...${group.line_group_id.slice(-8)}`;
        html += `<option value="${group.id}" ${selected}>${displayName}</option>`;
      });

      select.innerHTML = html;
    }

    async function loadGroupOrders() {
      const groupId = document.getElementById('group-selector').value;
      selectedGroupId = groupId;

      // æ›´æ–°ä»Šæ—¥åº—å®¶é¡¯ç¤ºï¼ˆæ ¹æ“šé¸æ“‡çš„ç¾¤çµ„ï¼‰
      updateTodayStoreInfo();

      if (!groupId) {
        document.getElementById('orders-content').innerHTML = '<div class="orders-empty">è«‹é¸æ“‡ç¾¤çµ„</div>';
        document.getElementById('stats-content').innerHTML = '<div class="orders-empty">è«‹é¸æ“‡ç¾¤çµ„</div>';
        currentGroupOrders = null;
        return;
      }

      try {
        const res = await authFetch(`/api/admin/groups/${groupId}/orders`);
        const data = await res.json();
        currentGroupOrders = data;

        updateGroupOrdersPanel(data);
        updateGroupStatsPanel(data);
      } catch (err) {
        console.error('è¼‰å…¥ç¾¤çµ„è¨‚å–®å¤±æ•—:', err);
        document.getElementById('orders-content').innerHTML = '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    function updateGroupOrdersPanel(sessions) {
      const content = document.getElementById('orders-content');

      if (!sessions || sessions.length === 0) {
        content.innerHTML = '<div class="orders-empty">è©²ç¾¤çµ„å°šç„¡è¨‚å–®</div>';
        return;
      }

      let html = '';
      sessions.forEach(session => {
        const orders = session.orders || [];
        orders.forEach(order => {
          const displayName = order.display_name || 'æœªçŸ¥';
          const itemsHtml = order.items.map(item => {
            let text = item.quantity > 1 ? `${item.name} x${item.quantity}` : item.name;
            let noteText = item.note ? `<span class="item-note">ï¼ˆ${item.note}ï¼‰</span>` : '';
            return `<div class="order-item-line">${text}${noteText} $${item.subtotal}</div>`;
          }).join('');

          const paidClass = order.payment_status === 'paid' ? 'paid' : '';
          const paidBadge = order.payment_status === 'paid'
            ? '<span class="payment-badge paid">å·²ä»˜</span>'
            : `<button class="btn btn-sm btn-primary" onclick="markPaid('${order.id}')">ç¢ºèªä»˜æ¬¾</button>`;

          html += `
            <div class="group-order-item ${paidClass}">
              <div class="group-order-header">
                <span class="group-order-user">ğŸ‘¤ ${displayName}</span>
                <span class="group-order-total">$${order.total}</span>
                ${paidBadge}
              </div>
              <div class="group-order-items">${itemsHtml}</div>
            </div>
          `;
        });
      });

      content.innerHTML = html || '<div class="orders-empty">è©²ç¾¤çµ„å°šç„¡è¨‚å–®</div>';
    }

    function updateGroupStatsPanel(sessions) {
      const content = document.getElementById('stats-content');

      // çµ±è¨ˆ
      let totalAmount = 0;
      let paidAmount = 0;
      let orderCount = 0;
      const itemCounts = {};

      sessions.forEach(session => {
        (session.orders || []).forEach(order => {
          orderCount++;
          totalAmount += order.total;
          if (order.payment_status === 'paid') {
            paidAmount += order.total;
          }

          (order.items || []).forEach(item => {
            const key = item.name;
            itemCounts[key] = (itemCounts[key] || 0) + item.quantity;
          });
        });
      });

      let html = `
        <div class="stats-overview">
          <div class="stat-item">
            <span class="stat-label">è¨‚å–®æ•¸</span>
            <span class="stat-value">${orderCount}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">ç¸½é‡‘é¡</span>
            <span class="stat-value">$${totalAmount}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">å·²æ”¶</span>
            <span class="stat-value stats-collected">$${paidAmount}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">å¾…æ”¶</span>
            <span class="stat-value stats-pending">$${totalAmount - paidAmount}</span>
          </div>
        </div>
      `;

      const itemEntries = Object.entries(itemCounts);
      if (itemEntries.length > 0) {
        html += '<div class="stats-items-title">ğŸ“¦ å“é …çµ±è¨ˆ</div>';
        html += '<div class="stats-items">';
        itemEntries.sort((a, b) => b[1] - a[1]).forEach(([name, count]) => {
          html += `<div class="stats-item-row"><span>${name}</span><span>x${count}</span></div>`;
        });
        html += '</div>';
      }

      content.innerHTML = html;
    }

    async function markPaid(orderId) {
      try {
        const res = await authFetch(`/api/admin/orders/${orderId}/mark-paid`, {
          method: 'POST'
        });

        if (res.ok) {
          showNotification('å·²æ¨™è¨˜ä»˜æ¬¾');
          await loadGroupOrders();
        }
      } catch (err) {
        console.error('æ¨™è¨˜ä»˜æ¬¾å¤±æ•—:', err);
        showNotification('æ“ä½œå¤±æ•—');
      }
    }

    // === ç¾¤çµ„ç”³è«‹ ===
    async function loadApplications() {
      try {
        const res = await authFetch('/api/admin/applications?status=pending');
        if (!res.ok) {
          console.error('è¼‰å…¥ç”³è«‹å¤±æ•—:', res.status);
          return;
        }
        const applications = await res.json();
        updateApplicationsPanel(applications);
      } catch (err) {
        console.error('è¼‰å…¥ç”³è«‹å¤±æ•—:', err);
      }
    }

    function updateApplicationsPanel(applications) {
      const content = document.getElementById('applications-content');
      applicationsData = applications || [];  // ä¿å­˜ç”³è«‹è³‡æ–™

      if (!applications || applications.length === 0) {
        content.innerHTML = '<div class="orders-empty">ç„¡å¾…å¯©æ ¸ç”³è«‹</div>';
        return;
      }

      let html = '';
      applications.forEach(app => {
        html += `
          <div class="application-item" onclick="openReviewModal('${app.id}')">
            <div class="application-name">${app.group_name}</div>
            <div class="application-info">
              <span>è¯çµ¡è³‡è¨Šï¼š${app.contact_info || '-'}</span>
              <span class="application-date">${new Date(app.created_at).toLocaleDateString()}</span>
            </div>
          </div>
        `;
      });

      content.innerHTML = html;
    }

    function openReviewModal(appId) {
      reviewingAppId = appId;
      // å¾ applicationsData æ‰¾åˆ°å°æ‡‰çš„ç”³è«‹è³‡æ–™
      const app = applicationsData.find(a => a.id === appId);

      if (!app) {
        document.getElementById('review-content').innerHTML = `
          <p>æ‰¾ä¸åˆ°ç”³è«‹è³‡æ–™</p>
        `;
        document.getElementById('review-modal').style.display = 'flex';
        return;
      }

      // é¡¯ç¤ºè©³ç›¡çš„ç”³è«‹è³‡è¨Š
      const createdAt = new Date(app.created_at).toLocaleString('zh-TW');
      document.getElementById('review-content').innerHTML = `
        <div class="review-detail">
          <div class="review-row">
            <span class="review-label">ç¾¤çµ„åç¨±ï¼š</span>
            <span class="review-value">${app.group_name || '-'}</span>
          </div>
          <div class="review-row">
            <span class="review-label">è¯çµ¡è³‡è¨Šï¼š</span>
            <span class="review-value">${app.contact_info || '-'}</span>
          </div>
          <div class="review-row">
            <span class="review-label">LINE ç¾¤çµ„ IDï¼š</span>
            <span class="review-value" style="font-size: 12px; word-break: break-all;">${app.line_group_id}</span>
          </div>
          <div class="review-row">
            <span class="review-label">ç¾¤çµ„ä»£ç¢¼ï¼š</span>
            <span class="review-value">${app.group_code || '-'}</span>
          </div>
          <div class="review-row">
            <span class="review-label">ç”³è«‹æ™‚é–“ï¼š</span>
            <span class="review-value">${createdAt}</span>
          </div>
        </div>
        <textarea id="review-note" placeholder="å¯©æ ¸å‚™è¨»ï¼ˆé¸å¡«ï¼‰"></textarea>
      `;
      document.getElementById('review-modal').style.display = 'flex';
    }

    function closeReviewModal() {
      reviewingAppId = null;
      document.getElementById('review-modal').style.display = 'none';
    }

    async function approveApplication() {
      if (!reviewingAppId) return;

      const note = document.getElementById('review-note').value;

      try {
        const res = await authFetch(`/api/admin/applications/${reviewingAppId}/review`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'approved', note })
        });

        if (res.ok) {
          showNotification('å·²é€šéç”³è«‹');
          closeReviewModal();
          await loadApplications();
          await loadGroups();
          await loadGroupsList();  // åˆ·æ–°åˆ†é åˆ—è¡¨
        }
      } catch (err) {
        console.error('å¯©æ ¸å¤±æ•—:', err);
        showNotification('æ“ä½œå¤±æ•—');
      }
    }

    async function rejectApplication() {
      if (!reviewingAppId) return;

      const note = document.getElementById('review-note').value;

      try {
        const res = await authFetch(`/api/admin/applications/${reviewingAppId}/review`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'rejected', note })
        });

        if (res.ok) {
          showNotification('å·²æ‹’çµ•ç”³è«‹');
          closeReviewModal();
          await loadApplications();
          await loadGroupsList();  // åˆ·æ–°åˆ†é åˆ—è¡¨
        }
      } catch (err) {
        console.error('å¯©æ ¸å¤±æ•—:', err);
        showNotification('æ“ä½œå¤±æ•—');
      }
    }

    // === AI æç¤ºè©ç®¡ç† ===
    async function loadPromptsPanel() {
      const content = document.getElementById('prompts-panel-content');
      try {
        const res = await authFetch('/api/admin/prompts');
        const prompts = await res.json();

        if (!prompts || prompts.length === 0) {
          content.innerHTML = '<div class="orders-empty">å°šç„¡æç¤ºè©</div>';
          return;
        }

        let html = '<div class="prompts-list">';
        prompts.forEach(prompt => {
          html += `
            <div class="prompt-list-item" onclick="openPromptsModal('${prompt.name}')">
              <span class="prompt-list-name">${prompt.name}</span>
              <span class="prompt-list-edit">âœï¸</span>
            </div>
          `;
        });
        html += '</div>';
        content.innerHTML = html;
      } catch (err) {
        console.error('è¼‰å…¥æç¤ºè©å¤±æ•—:', err);
        content.innerHTML = '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function openPromptsModal() {
      try {
        const res = await authFetch('/api/admin/prompts');
        const prompts = await res.json();

        let html = '';
        prompts.forEach(prompt => {
          html += `
            <div class="prompt-item">
              <div class="prompt-name">${prompt.name}</div>
              <textarea id="prompt-${prompt.name}" class="prompt-textarea">${prompt.content}</textarea>
              <button class="btn btn-sm btn-primary" onclick="savePrompt('${prompt.name}')">å„²å­˜</button>
            </div>
          `;
        });

        document.getElementById('prompts-list').innerHTML = html || '<p>å°šç„¡æç¤ºè©</p>';
        document.getElementById('prompts-modal').style.display = 'flex';
      } catch (err) {
        console.error('è¼‰å…¥æç¤ºè©å¤±æ•—:', err);
        showNotification('è¼‰å…¥å¤±æ•—');
      }
    }

    function closePromptsModal() {
      document.getElementById('prompts-modal').style.display = 'none';
    }

    async function savePrompt(name) {
      const content = document.getElementById(`prompt-${name}`).value;

      try {
        const res = await authFetch(`/api/admin/prompts/${name}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });

        if (res.ok) {
          showNotification('æç¤ºè©å·²å„²å­˜');
        }
      } catch (err) {
        console.error('å„²å­˜æç¤ºè©å¤±æ•—:', err);
        showNotification('å„²å­˜å¤±æ•—');
      }
    }

    // === æ‹–æ”¾æ”¯æ´ ===
    document.addEventListener('DOMContentLoaded', function() {
      const uploadArea = document.getElementById('upload-area');
      if (uploadArea) {
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
          if (e.dataTransfer.files.length > 0 && menuManager) {
            menuManager.handleImageSelect({ target: { files: e.dataTransfer.files } });
          }
        });
      }
    });

    // === é€šç”¨åŠŸèƒ½ ===
    function showNotification(message, type = 'success') {
      // å–å¾—æˆ–å»ºç«‹é€šçŸ¥å®¹å™¨
      let container = document.getElementById('notification-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.className = 'notification-container';
        document.body.appendChild(container);
      }

      const notif = document.createElement('div');
      notif.className = 'notification';
      if (type === 'error') {
        notif.style.background = '#f8d7da';
        notif.style.color = '#721c24';
        notif.style.borderLeft = '4px solid #dc3545';
      } else {
        notif.style.borderLeft = '4px solid #28a745';
      }
      notif.textContent = message;
      container.appendChild(notif);

      // æ·¡å‡ºä¸¦ç§»é™¤
      setTimeout(() => {
        notif.classList.add('fade-out');
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    function showDetailModal(title, content) {
      document.getElementById('detail-modal-title').textContent = title;
      document.getElementById('detail-modal-content').textContent = content;
      document.getElementById('detail-modal').style.display = 'flex';
    }

    function hideDetailModal() {
      document.getElementById('detail-modal').style.display = 'none';
    }

    function closeDetailModal(event) {
      if (event.target.id === 'detail-modal') {
        hideDetailModal();
      }
    }

    function showConfirm(message, title = 'ç¢ºèª') {
      return new Promise((resolve) => {
        document.getElementById('confirm-modal-title').textContent = title;
        document.getElementById('confirm-modal-message').textContent = message;
        document.getElementById('confirm-modal').style.display = 'flex';

        const okBtn = document.getElementById('confirm-modal-ok');
        const cancelBtn = document.getElementById('confirm-modal-cancel');

        const cleanup = () => {
          document.getElementById('confirm-modal').style.display = 'none';
          okBtn.replaceWith(okBtn.cloneNode(true));
          cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        };

        document.getElementById('confirm-modal-ok').onclick = () => {
          cleanup();
          resolve(true);
        };
        document.getElementById('confirm-modal-cancel').onclick = () => {
          cleanup();
          resolve(false);
        };
      });
    }

    // Socket.IO äº‹ä»¶
    socket.on('connect', () => {
      // åŠ å…¥å»£æ’­æˆ¿é–“ä»¥æ¥æ”¶å³æ™‚æ›´æ–°
      socket.emit('join_board', { group_id: 'all' });
      // å¦‚æœå·²ç™»å…¥ï¼ŒåŠ å…¥è¶…ç®¡æˆ¿é–“
      if (adminToken) {
        socket.emit('join_admin');
      }
    });

    socket.on('application_update', (data) => {
      // åªæœ‰å·²ç™»å…¥æ™‚æ‰é‡æ–°è¼‰å…¥ç”³è«‹åˆ—è¡¨
      if (adminToken) {
        loadApplications();
      }
      const action = data.action || 'update';
      if (action === 'new') {
        showNotification(`æ–°çš„ç¾¤çµ„ç”³è«‹ï¼š${data.application?.group_name || 'æœªçŸ¥'}`);
      }
    });

    socket.on('group_update', (data) => {
      // ç¾¤çµ„è³‡è¨Šæ›´æ–°ï¼ˆå¦‚æˆå“¡è®ŠåŒ–ï¼‰ï¼Œé‡æ–°è¼‰å…¥ç¾¤çµ„åˆ—è¡¨
      if (adminToken) {
        loadGroupsList();
        loadGroups();  // ä¹Ÿæ›´æ–°ä¸‹æ‹‰é¸å–®
      }
    });

    socket.on('order_update', (data) => {
      if (selectedGroupId) {
        loadGroupOrders();
      }
      const action = data.action || 'update';
      let message = `${data.display_name || data.user || 'æœ‰äºº'} æ›´æ–°äº†è¨‚å–®`;
      if (action === 'created') {
        message = `${data.display_name || 'æœ‰äºº'} æ–°å¢äº†è¨‚å–®`;
      } else if (action === 'cancelled') {
        message = `${data.display_name || 'æœ‰äºº'} å–æ¶ˆäº†è¨‚å–®`;
      } else if (action === 'cleared') {
        message = 'è¨‚å–®å·²æ¸…é™¤';
      }
      if (data.proxy) {
        message += ' (ä»£ç†)';
      }
      showNotification(message);
    });

    socket.on('session_status', (data) => {
      if (selectedGroupId) {
        loadGroupOrders();
      }
      const status = data.status;
      if (status === 'ordering') {
        showNotification('ç¾¤çµ„é–‹å§‹é»é¤');
      } else if (status === 'ended') {
        showNotification('ç¾¤çµ„é»é¤å·²çµæŸ');
      }
    });

    socket.on('payment_update', (data) => {
      if (selectedGroupId) {
        loadGroupOrders();
      }
      const status = data.payment_status;
      if (status === 'paid') {
        showNotification('è¨‚å–®å·²æ¨™è¨˜ä»˜æ¬¾');
      } else if (status === 'refunded') {
        showNotification('è¨‚å–®å·²é€€æ¬¾');
      }
    });

    socket.on('store_change', (data) => {
      const action = data.action || 'today_stores';
      if (action === 'store_created' || action === 'store_updated' || action === 'store_deleted') {
        // åº—å®¶åˆ—è¡¨è®Šæ›´ï¼Œé‡æ–°è¼‰å…¥
        loadAllStores();
        const actionText = action === 'store_created' ? 'æ–°å¢' : action === 'store_updated' ? 'æ›´æ–°' : 'åˆªé™¤';
        showNotification(`åº—å®¶ã€Œ${data.store_name}ã€å·²${actionText}`);
      } else {
        // ä»Šæ—¥åº—å®¶è®Šæ›´
        updateTodayStoreInfo();
        showNotification('ä»Šæ—¥åº—å®¶å·²æ›´æ–°');
      }
    });

    // æ‹–æ”¾æ”¯æ´
    const uploadArea = document.getElementById('upload-area');
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        document.getElementById('menu-image-input').files = e.dataTransfer.files;
        handleImageSelect({ target: { files: e.dataTransfer.files } });
      }
    });

    // === ç³»çµ±ç¶­è­· ===
    async function loadMaintenanceStats() {
      const content = document.getElementById('maintenance-content');
      try {
        const res = await authFetch('/api/admin/maintenance/chat-stats');
        const stats = await res.json();

        let oldestDate = 'ç„¡';
        if (stats.oldest_message_date) {
          oldestDate = new Date(stats.oldest_message_date).toLocaleDateString('zh-TW');
        }

        content.innerHTML = `
          <div class="maintenance-stats">
            <div class="maintenance-stat-row">
              <span>å°è©±è¨Šæ¯ç¸½æ•¸</span>
              <span class="maintenance-stat-value">${stats.total_messages.toLocaleString()}</span>
            </div>
            <div class="maintenance-stat-row">
              <span>è¶…éä¸€å¹´</span>
              <span class="maintenance-stat-value ${stats.messages_older_than_1_year > 0 ? 'warning' : ''}">${stats.messages_older_than_1_year.toLocaleString()}</span>
            </div>
            <div class="maintenance-stat-row">
              <span>æœ€èˆŠè¨Šæ¯</span>
              <span class="maintenance-stat-value">${oldestDate}</span>
            </div>
          </div>
          ${stats.messages_older_than_1_year > 0 ? `
            <button class="btn btn-sm btn-warning" onclick="cleanupChatMessages()" style="margin-top: 10px; width: 100%;">
              ğŸ§¹ æ¸…ç†èˆŠè¨Šæ¯ (${stats.messages_older_than_1_year} ç­†)
            </button>
          ` : `
            <div class="maintenance-info" style="margin-top: 10px; font-size: 12px; color: #666;">
              âœ… ç³»çµ±æœƒè‡ªå‹•æ¯æœˆæ¸…ç†è¶…éä¸€å¹´çš„è¨Šæ¯
            </div>
          `}
        `;
      } catch (err) {
        console.error('è¼‰å…¥ç¶­è­·çµ±è¨ˆå¤±æ•—:', err);
        content.innerHTML = '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function cleanupChatMessages() {
      if (!await showConfirm('ç¢ºå®šè¦æ¸…ç†è¶…éä¸€å¹´çš„å°è©±è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        return;
      }

      try {
        const res = await authFetch('/api/admin/maintenance/cleanup-chat?retention_days=365', {
          method: 'POST'
        });
        const data = await res.json();

        if (data.success) {
          showNotification(`å·²æ¸…ç† ${data.deleted_count} ç­†èˆŠè¨Šæ¯`);
          loadMaintenanceStats();
        } else {
          showNotification('æ¸…ç†å¤±æ•—');
        }
      } catch (err) {
        console.error('æ¸…ç†å¤±æ•—:', err);
        showNotification('æ¸…ç†å¤±æ•—');
      }
    }

    // === LINE Bot ç‹€æ…‹æª¢æŸ¥ ===
    const LINEBOT_CHECK_INTERVAL = 60000; // 60 ç§’
    let linebotCheckTimer = null;

    async function checkLineBotStatus() {
      const statusEl = document.getElementById('linebot-status');
      if (!statusEl) return;

      const iconEl = statusEl.querySelector('.linebot-status-icon');
      const textEl = statusEl.querySelector('.linebot-status-text');

      // é¡¯ç¤ºæª¢æŸ¥ä¸­ç‹€æ…‹
      statusEl.className = 'linebot-status checking';
      iconEl.textContent = 'ğŸ”„';
      textEl.textContent = 'æª¢æŸ¥ä¸­...';

      try {
        const res = await apiFetch('/api/public/linebot-status');
        const data = await res.json();

        if (data.status === 'online') {
          statusEl.className = 'linebot-status online';
          iconEl.textContent = 'ğŸŸ¢';
          textEl.textContent = data.message;
        } else {
          statusEl.className = 'linebot-status offline';
          iconEl.textContent = 'ğŸ”´';
          textEl.textContent = data.message;
        }
      } catch (err) {
        console.error('LINE Bot ç‹€æ…‹æª¢æŸ¥å¤±æ•—:', err);
        statusEl.className = 'linebot-status offline';
        iconEl.textContent = 'ğŸ”´';
        textEl.textContent = 'LINE Bot é›¢ç·š';
      }
    }

    function startLineBotCheck() {
      checkLineBotStatus();
      linebotCheckTimer = setInterval(checkLineBotStatus, LINEBOT_CHECK_INTERVAL);
    }
  </script>
</body>
</html>
