<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘·çˆ¸ - ä»Šæ—¥è¨‚é¤çœ‹æ¿</title>
  <link rel="icon" type="image/png" href="images/jaba-sm.png">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="container board-container">
    <div class="board board-wide">
      <!-- ä¸­ä¸Šï¼šæ¨™é¡Œ -->
      <div class="board-header">
        <h1 class="board-title"><img src="images/jaba-sm.png" alt="å‘·çˆ¸" class="logo-icon"> å‘·çˆ¸è¨‚é¤çœ‹æ¿</h1>
        <p class="board-subtitle" id="today-date"></p>
        <!-- ç¾¤çµ„é¸æ“‡å™¨ -->
        <div class="group-filter">
          <select id="group-filter-select" onchange="onGroupFilterChange()">
            <option value="">æ‰€æœ‰ç¾¤çµ„</option>
          </select>
        </div>
      </div>

      <!-- å·¦å³å…©æ¬„ -->
      <div class="board-columns">
        <!-- å·¦æ¬„ï¼šåº—å®¶ + èŠå¤© + QRCode -->
        <div class="board-left">
          <div class="store-name" id="store-name">
            <span class="no-store">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</span>
          </div>

          <!-- ç¾é£Ÿè©•è«–å€ï¼ˆå”¯è®€ï¼‰ -->
          <div class="orders-section">
            <h2 class="section-title">ğŸ’¬ ç¾é£Ÿè©•è«–å€</h2>
            <div class="chat-readonly" id="chat-readonly">
              <div class="empty-state">
                <p>å°šç„¡èŠå¤©è¨Šæ¯</p>
              </div>
            </div>
          </div>

          <!-- LINE å¥½å‹ QRCode -->
          <div class="qrcode-section">
            <img src="images/588voelu.png" alt="åŠ å…¥å‘·çˆ¸å¥½å‹" class="qrcode-image">
            <div class="qrcode-info">
              <p class="qrcode-title">åŠ å…¥å‘·çˆ¸å¥½å‹</p>
              <p class="qrcode-hint">æƒç¢¼åŠ å…¥ LINE ç¾¤çµ„é»é¤</p>
              <p class="linebot-status" id="linebot-status">
                <span class="linebot-status-icon">ğŸ”„</span>
                <span class="linebot-status-text">LINE Bot æª¢æŸ¥ä¸­...</span>
              </p>
            </div>
          </div>
        </div>

        <!-- å³æ¬„ï¼šè¨‚å–® + çµ±è¨ˆ + æŒ‰éˆ• -->
        <div class="board-right">
          <div class="orders-section">
            <h2 class="section-title">ğŸ“‹ è¨‚å–®åˆ—è¡¨</h2>
            <div class="orders-list" id="orders-list">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ½ï¸</div>
                <p>é‚„æ²’æœ‰äººè¨‚é¤</p>
              </div>
            </div>
          </div>

          <div class="orders-section">
            <h2 class="section-title">ğŸ“Š å“é …çµ±è¨ˆ</h2>
            <div class="item-summary" id="item-summary">
              <div class="empty-state">
                <p>å°šç„¡çµ±è¨ˆè³‡æ–™</p>
              </div>
            </div>
          </div>

          <div class="grand-total" id="grand-total">
            <div class="grand-total-label">ç¸½é‡‘é¡</div>
            <div class="grand-total-amount">$0</div>
          </div>

          <div class="buttons">
            <button class="btn btn-primary" onclick="showApplicationModal()">ğŸ“ ç”³è«‹é–‹é€š</button>
            <a href="line-admin.html" class="btn btn-secondary">ğŸ“± LINE ç®¡ç†</a>
            <a href="admin.html" class="btn btn-secondary">âš™ï¸ è¶…ç´šç®¡ç†å“¡</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç”³è«‹é–‹é€š Modal -->
  <div class="modal-overlay" id="application-modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>ğŸ“ ç”³è«‹é–‹é€šç¾¤çµ„</h3>
        <button class="modal-close" onclick="hideApplicationModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- ç”³è«‹è¡¨å–® -->
        <div id="application-form-section">
          <div class="form-group">
            <label>LINE ç¾¤çµ„ ID *</label>
            <input type="text" id="app-line-group-id" placeholder="ä¾‹ï¼šCab1234567890">
            <small style="color: #666;">åœ¨ç¾¤çµ„ä¸­è¼¸å…¥ã€Œidã€ï¼ŒBot æœƒå›è¦†ç¾¤çµ„ ID</small>
          </div>
          <div class="form-group">
            <label>ç¾¤çµ„åç¨± *</label>
            <input type="text" id="app-group-name" placeholder="ä¾‹ï¼šABCå…¬å¸åˆé¤åœ˜">
          </div>
          <div class="form-group">
            <label>è¯çµ¡è³‡è¨Š *</label>
            <input type="text" id="app-contact-info" placeholder="ä¾‹ï¼šå°æ˜ 0912-345-678">
          </div>
          <div class="form-group">
            <label>ç¾¤çµ„ä»£ç¢¼ *</label>
            <input type="text" id="app-group-code" placeholder="è¨­å®šä¸€çµ„æ–¹ä¾¿è¨˜æ†¶çš„ä»£ç¢¼ï¼ˆ4-20å­—å…ƒï¼‰">
            <div class="form-hint">
              ç”¨é€”èªªæ˜ï¼š<br>
              â€¢ ç™»å…¥ LINE ç®¡ç†å¾Œå°<br>
              â€¢ åœ¨ç¾¤çµ„ä¸­è¼¸å…¥ã€Œç®¡ç†å“¡ [ä»£ç¢¼]ã€å•Ÿç”¨ç®¡ç†å“¡èº«ä»½<br>
              <span style="color: #999; font-size: 0.9em;">æ­¤ä»£ç¢¼æœƒåœ¨ç¾¤çµ„å°è©±ä¸­é¡¯ç¤ºï¼Œä¸å…·ä¿å¯†æ€§ï¼Œå¯è¦–ç‚ºç¾¤çµ„è­˜åˆ¥ç¢¼ã€‚</span>
            </div>
          </div>
          <div style="margin-top: 15px;">
            <button class="btn btn-primary" onclick="submitApplication()" style="width: 100%;">æäº¤ç”³è«‹</button>
          </div>
        </div>

        <!-- æŸ¥è©¢ç‹€æ…‹ -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
          <h4 style="margin-bottom: 10px;">æŸ¥è©¢ç”³è«‹ç‹€æ…‹</h4>
          <div class="form-group" style="margin-bottom: 0;">
            <div style="display: flex; gap: 10px;">
              <input type="text" id="query-group-code" placeholder="è¼¸å…¥ç¾¤çµ„ä»£ç¢¼" style="flex: 1;">
              <button class="btn btn-secondary" onclick="queryApplicationStatus()">æŸ¥è©¢</button>
            </div>
          </div>
          <div id="application-status-result" style="margin-top: 10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // è‡ªå‹•åµæ¸¬ base pathï¼ˆæ”¯æ´ nginx åå‘ä»£ç†ï¼‰
    const basePath = window.location.pathname.includes('/jaba-ai/') ? '/jaba-ai' : '';

    function apiFetch(url, options = {}) {
      return fetch(basePath + url, options);
    }

    // Socket.IO é€£ç·š
    const socket = io({
      path: basePath + '/socket.io/'
    });
    let selectedGroupId = null;

    // === ç€è¦½å™¨é€šçŸ¥ ===
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function sendBrowserNotification(title, body, tag = null) {
      if ('Notification' in window && Notification.permission === 'granted') {
        const options = {
          body: body,
          icon: 'images/jaba-sm.png',
          tag: tag || `jaba-${Date.now()}`,
          requireInteraction: false
        };

        const notification = new Notification(title, options);
        notification.onclick = () => {
          window.focus();
          notification.close();
        };
      }
    }

    requestNotificationPermission();

    // é¡¯ç¤ºä»Šæ—¥æ—¥æœŸ
    const today = new Date();
    document.getElementById('today-date').textContent =
      `${today.getFullYear()}/${today.getMonth()+1}/${today.getDate()} æ˜ŸæœŸ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][today.getDay()]}`;

    // è¼‰å…¥ç¾¤çµ„åˆ—è¡¨
    async function loadGroups() {
      try {
        const res = await apiFetch('/api/board/groups');
        const groups = await res.json();
        const select = document.getElementById('group-filter-select');

        let html = '<option value="">æ‰€æœ‰ç¾¤çµ„</option>';
        groups.forEach(group => {
          html += `<option value="${group.id}">${group.name || 'æœªå‘½åç¾¤çµ„'}</option>`;
        });
        select.innerHTML = html;
      } catch (err) {
        console.error('è¼‰å…¥ç¾¤çµ„å¤±æ•—:', err);
      }
    }

    function onGroupFilterChange() {
      selectedGroupId = document.getElementById('group-filter-select').value || null;
      loadBoardData();
    }

    // è¼‰å…¥ä»Šæ—¥åº—å®¶
    async function loadTodayStores() {
      try {
        const url = selectedGroupId
          ? `/api/board/today-stores?group_id=${selectedGroupId}`
          : '/api/board/today-stores';
        const res = await apiFetch(url);
        const data = await res.json();
        updateStoreDisplay(data);
      } catch (err) {
        console.error('è¼‰å…¥åº—å®¶å¤±æ•—:', err);
      }
    }

    // æ›´æ–°åº—å®¶é¡¯ç¤º
    function updateStoreDisplay(data) {
      const storeNameEl = document.getElementById('store-name');

      // å½™æ•´æ‰€æœ‰åº—å®¶
      const allStores = [];
      data.forEach(groupData => {
        groupData.stores.forEach(store => {
          if (!allStores.find(s => s.store_id === store.store_id)) {
            allStores.push(store);
          }
        });
      });

      if (allStores.length > 0) {
        let storeHtml = '';
        allStores.forEach((store, index) => {
          if (index > 0) storeHtml += '<div class="store-divider-board"></div>';
          storeHtml += `<div class="store-name-item">ğŸª ${store.store_name || 'æœªçŸ¥åº—å®¶'}</div>`;
        });
        storeNameEl.innerHTML = storeHtml;
      } else {
        storeNameEl.innerHTML = '<span class="no-store">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</span>';
      }
    }

    // è¼‰å…¥è¨‚å–®
    async function loadOrders() {
      try {
        const url = selectedGroupId
          ? `/api/board/orders?group_id=${selectedGroupId}`
          : '/api/board/orders';
        const res = await apiFetch(url);
        const data = await res.json();
        updateOrdersDisplay(data);
      } catch (err) {
        console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', err);
      }
    }

    // æ›´æ–°è¨‚å–®é¡¯ç¤º
    function updateOrdersDisplay(data) {
      const ordersListEl = document.getElementById('orders-list');
      const itemSummaryEl = document.getElementById('item-summary');

      // å“é …çµ±è¨ˆ
      const itemCounts = {};
      let grandTotal = 0;

      if (data && data.length > 0) {
        let html = '';
        data.forEach((sessionData, index) => {
          if (index > 0) html += '<div class="orders-group-divider"></div>';

          const statusIcon = sessionData.session_status === 'ordering' ? 'ğŸŸ¢' : 'âšª';
          html += `<div class="orders-group-header">${statusIcon} ${sessionData.group_name}</div>`;

          sessionData.orders.forEach(order => {
            grandTotal += order.total;

            const itemsText = order.items.map(item => {
              // çµ±è¨ˆå“é …
              const key = item.note ? `${item.name}ï¼ˆ${item.note}ï¼‰` : item.name;
              itemCounts[key] = (itemCounts[key] || 0) + item.quantity;

              return `${item.name} x${item.quantity}${item.note ? ` (${item.note})` : ''}`;
            }).join('ã€');

            html += `
              <div class="order-card">
                <div>
                  <div class="order-user">${order.display_name || 'åŒ¿å'}</div>
                  <div class="order-items">${itemsText}</div>
                </div>
                <div class="order-total">$${order.total}</div>
              </div>
            `;
          });
        });
        ordersListEl.innerHTML = html;
      } else {
        ordersListEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ½ï¸</div>
            <p>é‚„æ²’æœ‰äººè¨‚é¤</p>
          </div>
        `;
      }

      // æ›´æ–°å“é …çµ±è¨ˆ
      const itemEntries = Object.entries(itemCounts);
      if (itemEntries.length > 0) {
        itemSummaryEl.innerHTML = itemEntries
          .sort((a, b) => b[1] - a[1])
          .map(([name, count]) => `<span class="item-badge">${name} x${count}</span>`)
          .join('');
      } else {
        itemSummaryEl.innerHTML = '<div class="empty-state"><p>å°šç„¡çµ±è¨ˆè³‡æ–™</p></div>';
      }

      // æ›´æ–°ç¸½é‡‘é¡
      document.querySelector('.grand-total-amount').textContent = `$${grandTotal}`;
    }

    // è¼‰å…¥èŠå¤©è¨Šæ¯
    async function loadChat() {
      try {
        const url = selectedGroupId
          ? `/api/board/chat?group_id=${selectedGroupId}`
          : '/api/board/chat';
        const res = await apiFetch(url);
        const messages = await res.json();
        updateChatDisplay(messages);
      } catch (err) {
        console.error('è¼‰å…¥èŠå¤©å¤±æ•—:', err);
      }
    }

    function updateChatDisplay(messages) {
      const chatEl = document.getElementById('chat-readonly');

      if (!messages || messages.length === 0) {
        chatEl.innerHTML = '<div class="empty-state"><p>å°šç„¡èŠå¤©è¨Šæ¯</p></div>';
        return;
      }

      // åªé¡¯ç¤ºæœ€è¿‘ 15 å‰‡è¨Šæ¯
      const recentMessages = messages.slice(-15);

      chatEl.innerHTML = recentMessages.map(msg => {
        const time = msg.created_at ? new Date(msg.created_at).toLocaleTimeString('zh-TW', {
          hour: '2-digit',
          minute: '2-digit'
        }) : '';
        const isJaba = msg.role === 'assistant' || msg.display_name === 'å‘·çˆ¸';
        const jabaClass = isJaba ? ' jaba' : '';
        const groupPrefix = msg.group_id ? `<span class="chat-group-name">[${msg.display_name}]</span> ` : '';
        const content = (msg.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `
          <div class="chat-readonly-message${jabaClass}">
            ${groupPrefix}<span class="chat-readonly-user">${msg.display_name}</span>
            <span class="chat-readonly-content">${content}</span>
            <span class="chat-readonly-time">${time}</span>
          </div>
        `;
      }).join('');

      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // è¼‰å…¥æ‰€æœ‰è³‡æ–™
    function loadBoardData() {
      loadTodayStores();
      loadOrders();
      loadChat();
    }

    // é¡¯ç¤ºé€šçŸ¥ - æ”¯æ´å †ç–Šé¡¯ç¤º
    function showNotification(message, type = 'success') {
      // å–å¾—æˆ–å»ºç«‹é€šçŸ¥å®¹å™¨
      let container = document.getElementById('notification-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.className = 'notification-container';
        document.body.appendChild(container);
      }

      const notif = document.createElement('div');
      notif.className = 'notification';
      if (type === 'error') {
        notif.style.background = '#f8d7da';
        notif.style.color = '#721c24';
        notif.style.borderLeft = '4px solid #dc3545';
      } else {
        notif.style.borderLeft = '4px solid #28a745';
      }
      notif.textContent = message;
      container.appendChild(notif);

      // æ·¡å‡ºä¸¦ç§»é™¤
      setTimeout(() => {
        notif.classList.add('fade-out');
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    // Socket.IO äº‹ä»¶
    socket.on('connect', () => {
      socket.emit('join_board', { group_id: selectedGroupId || 'all' });
    });

    socket.on('order_update', (data) => {
      const action = data.action || 'update';
      let message = `${data.display_name || data.user || 'æœ‰äºº'} æ›´æ–°äº†è¨‚å–®ï¼`;
      if (action === 'created') {
        message = `${data.display_name || 'æœ‰äºº'} æ–°å¢äº†è¨‚å–®ï¼`;
      } else if (action === 'cancelled') {
        message = `${data.display_name || 'æœ‰äºº'} å–æ¶ˆäº†è¨‚å–®`;
      } else if (action === 'cleared') {
        message = 'è¨‚å–®å·²æ¸…é™¤';
      }
      showNotification(message);
      sendBrowserNotification('è¨‚å–®æ›´æ–°', message);
      loadOrders();
    });

    socket.on('chat_message', (data) => {
      loadChat();
    });

    socket.on('session_status', (data) => {
      const status = data.status;
      if (status === 'ordering') {
        showNotification('é–‹å§‹é»é¤äº†ï¼');
        sendBrowserNotification('é»é¤é–‹å§‹', 'ç¾¤çµ„å·²é–‹å§‹é»é¤');
      } else if (status === 'ended') {
        showNotification('é»é¤å·²çµæŸ');
        sendBrowserNotification('é»é¤çµæŸ', 'ç¾¤çµ„é»é¤å·²çµæŸ');
      }
      loadOrders();
    });

    socket.on('payment_update', (data) => {
      const status = data.payment_status;
      if (status === 'paid') {
        showNotification('æœ‰è¨‚å–®å·²ä»˜æ¬¾');
      } else if (status === 'refunded') {
        showNotification('æœ‰è¨‚å–®å·²é€€æ¬¾');
      }
      loadOrders();
    });

    socket.on('store_change', (data) => {
      showNotification('ä»Šæ—¥åº—å®¶å·²æ›´æ–°');
      loadTodayStores();
    });

    // å¥åº·æª¢æŸ¥ / LINE Bot ç‹€æ…‹
    async function checkLineBotStatus() {
      const statusEl = document.getElementById('linebot-status');
      const iconEl = statusEl.querySelector('.linebot-status-icon');
      const textEl = statusEl.querySelector('.linebot-status-text');

      try {
        const res = await fetch('health');
        const data = await res.json();

        if (data.status === 'healthy') {
          statusEl.className = 'linebot-status online';
          iconEl.textContent = 'ğŸŸ¢';
          textEl.textContent = 'ç³»çµ±é‹ä½œä¸­';
        } else {
          statusEl.className = 'linebot-status offline';
          iconEl.textContent = 'ğŸ”´';
          textEl.textContent = 'ç³»çµ±ç•°å¸¸';
        }
      } catch (err) {
        statusEl.className = 'linebot-status offline';
        iconEl.textContent = 'ğŸ”´';
        textEl.textContent = 'ç„¡æ³•é€£ç·š';
      }
    }

    // åˆå§‹åŒ–
    loadGroups();
    loadBoardData();
    checkLineBotStatus();

    // å®šæœŸåˆ·æ–°
    setInterval(loadBoardData, 30000);
    setInterval(checkLineBotStatus, 60000);

    // === ç”³è«‹é–‹é€šåŠŸèƒ½ ===
    function showApplicationModal() {
      document.getElementById('application-modal').style.display = 'flex';
    }

    function hideApplicationModal() {
      document.getElementById('application-modal').style.display = 'none';
    }

    async function submitApplication() {
      const lineGroupId = document.getElementById('app-line-group-id').value.trim();
      const groupName = document.getElementById('app-group-name').value.trim();
      const contactInfo = document.getElementById('app-contact-info').value.trim();
      const groupCode = document.getElementById('app-group-code').value.trim();

      if (!lineGroupId || !groupName || !contactInfo || !groupCode) {
        showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
        return;
      }

      if (groupCode.length < 4 || groupCode.length > 20) {
        showNotification('ç¾¤çµ„ä»£ç¢¼é•·åº¦éœ€ç‚º 4-20 å­—å…ƒ', 'error');
        return;
      }

      try {
        const res = await apiFetch('/api/line-admin/applications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            line_group_id: lineGroupId,
            group_name: groupName,
            contact_info: contactInfo,
            group_code: groupCode,
          }),
        });

        if (res.ok) {
          showNotification('ç”³è«‹å·²æäº¤ï¼è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸ã€‚');
          document.getElementById('app-line-group-id').value = '';
          document.getElementById('app-group-name').value = '';
          document.getElementById('app-contact-info').value = '';
          document.getElementById('app-group-code').value = '';
          hideApplicationModal();
        } else {
          const data = await res.json();
          showNotification(data.detail || 'ç”³è«‹å¤±æ•—', 'error');
        }
      } catch (err) {
        console.error('æäº¤ç”³è«‹å¤±æ•—:', err);
        showNotification('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
    }

    async function queryApplicationStatus() {
      const groupCode = document.getElementById('query-group-code').value.trim();
      const resultEl = document.getElementById('application-status-result');

      if (!groupCode) {
        showNotification('è«‹è¼¸å…¥ç¾¤çµ„ä»£ç¢¼', 'error');
        return;
      }

      try {
        const res = await apiFetch(`/api/line-admin/applications/by-code/${encodeURIComponent(groupCode)}`);
        const applications = await res.json();

        if (!applications || applications.length === 0) {
          resultEl.innerHTML = '<div style="color: #666;">æŸ¥ç„¡ç”³è«‹è¨˜éŒ„</div>';
          return;
        }

        const statusMap = {
          pending: '<span style="color: #ffc107;">â³ å¯©æ ¸ä¸­</span>',
          approved: '<span style="color: #28a745;">âœ… å·²é€šé</span>',
          rejected: '<span style="color: #dc3545;">âŒ å·²æ‹’çµ•</span>',
        };

        resultEl.innerHTML = applications.map(app => `
          <div style="padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px;">
            <div><strong>${app.group_name}</strong> ${statusMap[app.status] || app.status}</div>
            <div style="font-size: 0.9em; color: #666;">ç”³è«‹æ™‚é–“ï¼š${new Date(app.created_at).toLocaleString()}</div>
            ${app.review_note ? `<div style="font-size: 0.9em; color: #999;">å‚™è¨»ï¼š${app.review_note}</div>` : ''}
          </div>
        `).join('');
      } catch (err) {
        console.error('æŸ¥è©¢å¤±æ•—:', err);
        resultEl.innerHTML = '<div style="color: #dc3545;">æŸ¥è©¢å¤±æ•—</div>';
      }
    }

    // é»æ“Š Modal å¤–éƒ¨é—œé–‰
    document.getElementById('application-modal').addEventListener('click', (e) => {
      if (e.target.id === 'application-modal') {
        hideApplicationModal();
      }
    });
  </script>
</body>
</html>
