# Proposal: add-admin-binding-command

## Why

目前群組管理員系統存在設計缺陷：

1. 群組申請審核通過時，系統建立**虛擬用戶**（`{群組ID}_admin`）作為管理員
2. 這個虛擬用戶是用於網頁後台登入的，不是真正的 LINE 用戶
3. 當真實 LINE 用戶在群組中輸入管理員指令（如「今日店家」）時，系統用其真實 `line_user_id` 查詢，找不到管理員記錄
4. 結果：**管理員指令完全無法使用**

這是一個嚴重的 bug，導致剛實作的群組管理員店家指令功能無法運作。

## What Changes

### 新增功能

1. **管理員綁定指令** - 讓真實 LINE 用戶透過密碼驗證綁定為群組管理員
2. **更新申請頁面說明** - 說明密碼也可用於群組內綁定管理員身份

### 指令格式

```
管理員 [密碼]
```

範例：
```
用戶輸入：管理員 1234
系統回應：✅ 已綁定為群組管理員！現在可以使用以下指令：
         • 今日店家 - 查看今日店家
         • 設定店家 [店名] - 設定今日店家
         • 加店家 [店名] - 新增店家
         • 移除店家 [店名] - 移除店家
         • 清除店家 - 清除所有
```

### 密碼命名評估

| 現有名稱 | 替代方案 | 建議 |
|---------|---------|-----|
| 管理密碼 | 管理驗證碼、管理員代碼 | **保留「管理密碼」** |

**理由**：
- 「密碼」一詞已被廣泛理解
- 改名需要更新多處 UI 和說明
- 只需補充說明即可：「此密碼用於登入管理後台，**也可在群組中綁定管理員身份**」

## Scope

### In Scope
- 群組中「管理員 [密碼]」綁定指令
- 驗證密碼對應 `group_applications.admin_password`
- 綁定成功後將用戶加入 `group_admins`
- 更新申請頁面說明文字

### Out of Scope
- 修改密碼欄位名稱
- 修改現有申請流程

## Affected Capabilities
- `line-bot` (MODIFIED) - 新增管理員綁定指令處理

## Key Decisions

1. **指令格式**：使用「管理員 [密碼]」，簡潔直覺
2. **密碼來源**：使用 `group_applications.admin_password`（申請時設定的密碼）
3. **重複綁定**：如果用戶已是管理員，提示「您已經是管理員」
4. **密碼錯誤**：提示「密碼錯誤」，不透露更多資訊
5. **群組匹配**：根據當前群組的 `line_group_id` 查找對應的已核准申請

## Technical Details

### 密碼驗證流程

```
1. 用戶輸入「管理員 1234」
2. 取得當前群組的 line_group_id
3. 查詢 group_applications：
   - WHERE line_group_id = ? AND status = 'approved'
4. 比對 admin_password
5. 驗證成功 → 將用戶加入 group_admins
```

### 安全考量

- 密碼驗證失敗不會透露申請是否存在
- 綁定後密碼仍可用於網頁後台登入（不互斥）
- 同一群組可以有多個管理員

## Dependencies
- `GroupApplicationRepository` - 查詢已核准的申請
- `GroupAdminRepository.add_admin()` - 新增管理員

## Risks
- **低風險**：只新增一個指令，不影響現有功能
