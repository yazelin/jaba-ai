# Design: add-hybrid-store-menu-management

## Context

ç›®å‰ jaba-ai çš„åº—å®¶/èœå–®æ¶æ§‹æ˜¯å…¨å±€å…±äº«çš„ï¼Œåªæœ‰è¶…ç´šç®¡ç†å“¡èƒ½é€éå¾Œå°å»ºç«‹å’Œç·¨è¼¯ã€‚é€™é™åˆ¶äº† LINE ç®¡ç†å“¡çš„è‡ªä¸»æ€§ï¼Œä¹Ÿç„¡æ³•æ»¿è¶³ä¸åŒç¾¤çµ„æœ‰å„è‡ªå¸¸ç”¨åº—å®¶çš„éœ€æ±‚ã€‚

èˆŠå°ˆæ¡ˆ (jaba) å·²æœ‰èœå–®å·®ç•°æ¯”å°åŠŸèƒ½ (`compare_menus`)ï¼Œå¯ç§»æ¤ä½¿ç”¨ã€‚

## Goals / Non-Goals

**Goals:**
- LINE ç®¡ç†å“¡å¯è‡ªä¸»æ–°å¢/ç·¨è¼¯ç¾¤çµ„å°ˆå±¬åº—å®¶
- è¶…ç®¡å»ºç«‹çš„å…¨å±€åº—å®¶å—ä¿è­·ï¼ŒLINE ç®¡ä¸å¯ä¿®æ”¹
- æ”¯æ´èœå–®å·®ç•°é è¦½å’Œé¸æ“‡æ€§æ›´æ–°
- AI Prompt æ­£ç¢ºæ³¨å…¥å…©å±¤ç´šåº—å®¶è³‡è¨Š

**Non-Goals:**
- åº—å®¶åˆä½µ/å‡ç´šåŠŸèƒ½
- ä¿ƒéŠ·æœ‰æ•ˆæœŸé™ç®¡ç†
- è·¨ç¾¤çµ„å…±äº«ç¾¤çµ„åº—å®¶

## Decisions

### 1. è³‡æ–™åº«çµæ§‹è®Šæ›´

**Store è¡¨æ–°å¢æ¬„ä½ï¼š**

```python
class Store(Base):
    # ... ç¾æœ‰æ¬„ä½ ...

    # æ–°å¢æ¬„ä½
    scope: Mapped[str] = mapped_column(
        String(16), default="global", index=True
    )  # "global" | "group"

    group_code: Mapped[Optional[str]] = mapped_column(
        String(64), index=True
    )  # scope=group æ™‚çš„ç¾¤çµ„ä»£ç¢¼

    created_by_type: Mapped[str] = mapped_column(
        String(16), default="admin"
    )  # "admin" | "line_admin"
```

**æŸ¥è©¢é‚è¼¯ï¼š**

```python
# LINE ç®¡ç†å“¡å¯è¦‹çš„åº—å®¶
async def get_stores_for_group_code(group_code: str) -> list[Store]:
    """å–å¾—ç¾¤çµ„å¯ç”¨çš„åº—å®¶ï¼ˆå…¨å±€ + ç›¸åŒ group_codeï¼‰"""
    return await session.execute(
        select(Store).where(
            or_(
                Store.scope == "global",
                and_(
                    Store.scope == "group",
                    Store.group_code == group_code
                )
            ),
            Store.is_active == True
        )
    )
```

### 2. æ¬Šé™çŸ©é™£

| æ“ä½œ | è¶…ç´šç®¡ç†å“¡ | LINE ç®¡ç†å“¡ |
|-----|-----------|------------|
| æŸ¥çœ‹å…¨å±€åº—å®¶ | âœ… | âœ… |
| æŸ¥çœ‹ç¾¤çµ„åº—å®¶ | âœ… å…¨éƒ¨ | âœ… åƒ…ç›¸åŒ group_code |
| æ–°å¢å…¨å±€åº—å®¶ | âœ… | âŒ |
| æ–°å¢ç¾¤çµ„åº—å®¶ | âœ… | âœ… (è‡ªå‹•è¨­ group_code) |
| ç·¨è¼¯å…¨å±€åº—å®¶ | âœ… | âŒ |
| ç·¨è¼¯ç¾¤çµ„åº—å®¶ | âœ… å…¨éƒ¨ | âœ… åƒ…ç›¸åŒ group_code |
| åˆªé™¤åº—å®¶ | âœ… | âœ… åƒ…è‡ªå·±å»ºç«‹çš„ |

### 3. èœå–®å·®ç•°æ¯”å°

ç§»æ¤èˆŠå°ˆæ¡ˆçš„ `compare_menus` å‡½å¼ï¼š

```python
def compare_menus(existing_menu: dict | None, recognized_menu: dict) -> dict:
    """æ¯”å°ç¾æœ‰èœå–®èˆ‡è¾¨è­˜çµæœçš„å·®ç•°

    Returns:
        {
            "added": [...],      # æ–°å“é …
            "modified": [...],   # åƒ¹æ ¼/å…§å®¹è®Šæ›´
            "unchanged": [...],  # ç„¡è®Šæ›´
            "removed": [...]     # å¯èƒ½å·²åœå”®
        }
    """
```

æ¯”å°é‚è¼¯ï¼š
- ä»¥å“é …åç¨±ç‚ºä¸»éµï¼ˆæ­£è¦åŒ–ï¼šå»é™¤ç©ºç™½ã€æ¨™é»ï¼‰
- æ¯”å°æ¬„ä½ï¼šname, price, variants, promo
- modified é¡¯ç¤ºè®Šæ›´è©³æƒ…ï¼ˆå¦‚ï¼šåƒ¹æ ¼ $40 â†’ $45ï¼‰

### 4. å·®ç•°é è¦½ UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ èœå–®å·®ç•°é è¦½                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… æ–°å¢å“é … (3)                    [å…¨é¸] [å–æ¶ˆ] â”‚
â”‚   â˜‘ ğŸŸ¢ èŠ‹é ­é®®å¥¶èŒ¶  $65                          â”‚
â”‚   â˜‘ ğŸŸ¢ è‘¡è„æŸšç¶ èŒ¶  $70                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ ä¿®æ”¹å“é … (2)                    [å…¨é¸] [å–æ¶ˆ] â”‚
â”‚   â˜‘ ğŸŸ¡ é˜¿è–©å§†å¥¶èŒ¶  $40 â†’ $45                    â”‚
â”‚   â˜‘ ğŸŸ¡ èŒ‰è‰ç¶ èŒ¶    M $30 â†’ M $32                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ—‘ï¸ åˆªé™¤å“é … (1)                    [å…¨é¸] [å–æ¶ˆ] â”‚
â”‚   â˜ ğŸ”´ å†¬ç“œèŒ¶      $25  (è¾¨è­˜çµæœä¸­æœªå‡ºç¾)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        [å–æ¶ˆ]                    [å¥—ç”¨é¸å–é …ç›®]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. å„²å­˜ API

```
POST /api/admin/stores/{store_id}/menu/save
POST /api/line-admin/stores/{store_id}/menu/save

{
  "diff_mode": true,
  "apply_items": ["item-id-1", "item-id-2"],  // å¥—ç”¨çš„å“é …
  "remove_items": ["item-id-old"]              // åˆªé™¤çš„å“é …
}
```

- `diff_mode=false`ï¼šå®Œæ•´è¦†è“‹æ¨¡å¼
- `diff_mode=true`ï¼šé¸æ“‡æ€§æ›´æ–°æ¨¡å¼

### 6. AI Prompt æ³¨å…¥

èª¿æ•´åº—å®¶è³‡è¨Šæ³¨å…¥é †åºï¼š

```python
def build_store_context(group_code: str) -> str:
    """å»ºç«‹åº—å®¶ä¸Šä¸‹æ–‡ï¼ˆä¾› AI ä½¿ç”¨ï¼‰"""
    group_stores = get_stores_by_scope("group", group_code)
    global_stores = get_stores_by_scope("global")

    context = "ã€ç¾¤çµ„å°ˆå±¬åº—å®¶ã€‘\n"
    for store in group_stores:
        context += f"- {store.name}\n"

    context += "\nã€å…¨å±€å…±ç”¨åº—å®¶ã€‘\n"
    for store in global_stores:
        context += f"- {store.name}\n"

    return context
```

## API è¨­è¨ˆ

### LINE ç®¡ç†å“¡åº—å®¶ API

```
GET    /api/line-admin/stores                 # å–å¾—å¯ç”¨åº—å®¶åˆ—è¡¨
POST   /api/line-admin/stores                 # æ–°å¢ç¾¤çµ„åº—å®¶
GET    /api/line-admin/stores/{id}            # å–å¾—åº—å®¶è©³æƒ…
PUT    /api/line-admin/stores/{id}            # æ›´æ–°åº—å®¶ï¼ˆéœ€æ¬Šé™æª¢æŸ¥ï¼‰
DELETE /api/line-admin/stores/{id}            # åˆªé™¤åº—å®¶ï¼ˆéœ€æ¬Šé™æª¢æŸ¥ï¼‰

GET    /api/line-admin/stores/{id}/menu       # å–å¾—èœå–®
POST   /api/line-admin/stores/{id}/menu       # ä¸Šå‚³/è¾¨è­˜èœå–®
PUT    /api/line-admin/stores/{id}/menu       # ç·¨è¼¯èœå–®
POST   /api/line-admin/stores/{id}/menu/save  # å„²å­˜èœå–®ï¼ˆæ”¯æ´ diff_modeï¼‰
GET    /api/line-admin/stores/{id}/menu/compare # èœå–®å·®ç•°æ¯”å°
```

### è¶…ç´šç®¡ç†å“¡åº—å®¶ APIï¼ˆæ“´å……ï¼‰

```
GET    /api/admin/stores                 # å–å¾—æ‰€æœ‰åº—å®¶ï¼ˆå« scope ç¯©é¸ï¼‰
POST   /api/admin/stores                 # æ–°å¢åº—å®¶ï¼ˆå¯æŒ‡å®š scopeï¼‰
# ... å…¶ä»– CRUD åŒä¸Š
```

## Migration

```python
def upgrade():
    # æ–°å¢æ¬„ä½
    op.add_column('stores', sa.Column('scope', sa.String(16), default='global'))
    op.add_column('stores', sa.Column('group_code', sa.String(64), nullable=True))
    op.add_column('stores', sa.Column('created_by_type', sa.String(16), default='admin'))

    # å»ºç«‹ç´¢å¼•
    op.create_index('ix_stores_scope', 'stores', ['scope'])
    op.create_index('ix_stores_group_code', 'stores', ['group_code'])

    # ç¾æœ‰è³‡æ–™è¨­ç‚º global
    op.execute("UPDATE stores SET scope = 'global', created_by_type = 'admin'")
```

## Risks / Trade-offs

| é¢¨éšª | ç·©è§£æªæ–½ |
|------|----------|
| åº—å®¶åç¨±é‡è¤‡æ··æ·† | æŸ¥è©¢æ™‚æ¨™ç¤º [å…¨å±€] / [ç¾¤çµ„å°ˆå±¬] |
| LINE ç®¡èª¤åˆªé‡è¦åº—å®¶ | è»Ÿåˆªé™¤ï¼Œè¶…ç®¡å¯æ¢å¾© |
| æ¬Šé™åˆ¤æ–·è¤‡é›œ | å»ºç«‹ `StorePermissionService` çµ±ä¸€è™•ç† |
| èœå–®å·®ç•°è¨ˆç®—è€—æ™‚ | å‰ç«¯é¡¯ç¤ºè¼‰å…¥å‹•ç•« |

## Open Questions

1. **ç¾¤çµ„åº—å®¶æ˜¯å¦å¯å‡ç´šç‚ºå…¨å±€åº—å®¶ï¼Ÿ**
   - ç›®å‰è¨­è¨ˆï¼šä¸æ”¯æ´ï¼ˆOut of Scopeï¼‰
   - å¯è€ƒæ…®ï¼šæœªä¾†ç”±è¶…ç®¡æ‰‹å‹•æ“ä½œ

2. **ç›¸åŒ group_code çš„ç¾¤çµ„æ˜¯å¦å…±äº«ç¾¤çµ„åº—å®¶ï¼Ÿ**
   - ç›®å‰è¨­è¨ˆï¼šæ˜¯ï¼ˆç›¸åŒä»£ç¢¼ = åŒä¸€ç®¡ç†ç¾¤ï¼‰
   - é€™ç¬¦åˆç¾æœ‰ group_code çš„è¨­è¨ˆç†å¿µ

3. **LINE ç®¡å»ºç«‹çš„åº—å®¶ï¼Œè¶…ç®¡æ˜¯å¦å¯è¦‹ï¼Ÿ**
   - ç›®å‰è¨­è¨ˆï¼šè¶…ç®¡å¯è¦‹æ‰€æœ‰åº—å®¶
   - è¶…ç®¡å¯ä»¥ã€Œæ¥ç®¡ã€ç¾¤çµ„åº—å®¶è®Šæˆå…¨å±€åº—å®¶ï¼ˆå¦‚æœæœªä¾†éœ€è¦ï¼‰
